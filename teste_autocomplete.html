<!DOCTYPE html>
<html>
<head>
    <title>Teste Autocomplete Cliente</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>Teste de Autocomplete - Debug</h2>
    
    <div>
        <label>Cliente:</label>
        <input type="text" id="cliente_input" list="clientes_list" placeholder="Digite para buscar...">
        <datalist id="clientes_list"></datalist>
        <input type="hidden" id="cliente_id">
    </div>
    
    <div style="margin-top: 20px;">
        <label>CPF/CNPJ:</label>
        <input type="text" id="cpf" readonly>
    </div>
    
    <div>
        <label>Telefone:</label>
        <input type="text" id="telefone" readonly>
    </div>
    
    <div>
        <label>Email:</label>
        <input type="text" id="email" readonly>
    </div>
    
    <div>
        <label>Endere√ßo:</label>
        <input type="text" id="endereco" readonly>
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="testarPreenchimento()">Testar Preenchimento Manual</button>
        <button onclick="limparCampos()">Limpar Campos</button>
    </div>
    
    <div id="logs" style="margin-top: 20px; padding: 10px; background: #f0f0f0; height: 300px; overflow-y: scroll;"></div>

    <script>
        // Redirecionar console.log para nossa div de logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += args.join(' ') + '<br>';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };
        
        console.log('=== INICIANDO TESTE DE AUTOCOMPLETE ===');
        
        const clienteInput = document.getElementById('cliente_input');
        const clienteIdInput = document.getElementById('cliente_id');
        const datalist = document.getElementById('clientes_list');
        
        let clientesSelecionaveis = {};
        let timeoutBusca = null;
        
        function buscarClientes(termo) {
            console.log('üîç Buscando clientes para:', termo);
            
            if (termo.length < 2) {
                datalist.innerHTML = '';
                clientesSelecionaveis = {};
                return;
            }
            
            fetch(`http://127.0.0.1:5000/clientes/api/busca?q=${encodeURIComponent(termo)}`)
                .then(response => response.json())
                .then(clientes => {
                    console.log('‚úÖ Clientes recebidos:', clientes);
                    
                    datalist.innerHTML = '';
                    clientesSelecionaveis = {};
                    
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        const displayText = `${cliente.nome} (${cliente.cpf_cnpj || 'CPF/CNPJ n√£o informado'})`;
                        option.value = displayText;
                        option.setAttribute('data-id', cliente.id);
                        datalist.appendChild(option);
                        
                        clientesSelecionaveis[displayText] = cliente;
                        console.log('üìù Cliente adicionado ao cache:', displayText, cliente);
                    });
                })
                .catch(error => {
                    console.error('‚ùå Erro ao buscar clientes:', error);
                });
        }
        
        function validarClienteInput() {
            const inputValue = clienteInput.value.trim();
            const clienteSelecionado = clientesSelecionaveis[inputValue];
            
            console.log('üîç Validando cliente:', {
                inputValue: inputValue,
                clienteEncontrado: !!clienteSelecionado,
                cacheClientes: Object.keys(clientesSelecionaveis)
            });
            
            if (clienteSelecionado) {
                console.log('‚úÖ Cliente v√°lido encontrado:', clienteSelecionado);
                clienteIdInput.value = clienteSelecionado.id;
                preencherDadosCliente(clienteSelecionado);
            } else {
                console.log('‚ö† Cliente n√£o encontrado no cache');
                clienteIdInput.value = '';
                limparDadosCliente();
            }
        }
        
        function preencherDadosCliente(cliente) {
            console.log('üìù Preenchendo dados do cliente:', cliente);
            
            const campos = {
                'cpf': cliente.cpf_cnpj,
                'telefone': cliente.telefone,
                'email': cliente.email,
                'endereco': cliente.endereco
            };
            
            Object.keys(campos).forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.value = campos[campoId] || '';
                    console.log(`‚úèÔ∏è Campo '${campoId}': '${campo.value}'`);
                } else {
                    console.log(`‚ùå Campo '${campoId}' n√£o encontrado`);
                }
            });
        }
        
        function limparDadosCliente() {
            console.log('üßπ Limpando dados do cliente');
            ['cpf', 'telefone', 'email', 'endereco'].forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.value = '';
                }
            });
        }
        
        // Eventos
        clienteInput.addEventListener('input', function() {
            const termo = this.value.trim();
            if (timeoutBusca) clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(() => {
                buscarClientes(termo);
                setTimeout(validarClienteInput, 100);
            }, 300);
        });
        
        clienteInput.addEventListener('change', function() {
            console.log('üîÑ Campo cliente alterado para:', this.value);
            validarClienteInput();
        });
        
        // Fun√ß√µes de teste
        function testarPreenchimento() {
            const clienteTeste = {
                id: 1,
                nome: 'Cliente Teste',
                cpf_cnpj: '12345678901',
                telefone: '(11) 99999-9999',
                email: 'teste@teste.com',
                endereco: 'Rua Teste, 123'
            };
            
            console.log('üß™ Testando preenchimento manual...');
            preencherDadosCliente(clienteTeste);
        }
        
        function limparCampos() {
            console.log('üßπ Limpando todos os campos...');
            clienteInput.value = '';
            clienteIdInput.value = '';
            limparDadosCliente();
        }
        
        console.log('‚úÖ Sistema de teste inicializado!');
    </script>
</body>
</html>
