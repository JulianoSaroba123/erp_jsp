<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Orçamento {{ orcamento.codigo }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (use o mesmo do seu base.html, se preferir remova esta linha) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --prim:#ff9d00;   /* cor destaque (cabeçalho/badges) */
      --cinza:#6c757d;
      --borda:#e9ecef;
    }
    body{ background:#fff; color:#212529; font-size:0.95rem; }
    .doc { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .brand-bar{ background:var(--prim); color:#111; border-radius:12px 12px 0 0; padding:14px 18px; }
    .brand-bar h1{ font-size:1.25rem; margin:0; font-weight:700; }
    .card-block{ border:1px solid var(--borda); border-radius:0 0 12px 12px; padding:18px 18px 6px; }
    .header-row .empresa h2{ font-size:1.1rem; margin-bottom:2px; font-weight:700; }
    .header-row .empresa small{ color:#495057; display:block; }
    .header-row .contacts { text-align:right; }
    .badge-status{ background:#111; color:#fff; border-radius:999px; padding:6px 12px; font-size:.8rem; }
    .badge-status.pendente{ background:#ffc107; color:#111; }
    .badge-status.aprovado{ background:#198754; }
    .badge-status.recusado{ background:#dc3545; }

    .kv{ display:grid; grid-template-columns: 180px 1fr; gap:8px 14px; }
    .section-title{ font-weight:700; color:#111; border-left:4px solid var(--prim); padding-left:10px; margin:22px 0 10px; }
    .table thead th{ background:#f8f9fa; border-bottom:2px solid var(--borda); }
    .table tfoot th{ background:#fff; border-top:2px solid var(--borda); }
    .totais .row{ margin-top:8px; }
    .totais .lbl{ color:#495057; }
    .totais .val{ font-weight:700; }
    .observacoes, .termos{ white-space:pre-wrap; }
    .assinaturas{ margin-top:32px; }
    .assinaturas .line{ border-top:1px solid #adb5bd; height:2px; margin-top:48px; }
    .assinaturas small{ color:#495057; }

    /* Imprimir limpo */
    @media print {
      .no-print{ display:none !important; }
      body { margin: 0; }
      .doc{ margin:0; max-width:none; }
      a[href]:after{ content:""; } /* remove urls */
    }
  </style>
</head>

<body>
<div class="doc">
  <!-- Cabeçalho -->
  <div class="brand-bar d-flex align-items-center justify-content-between">
    <h1>Orçamento</h1>
    <span class="badge-status {{ orcamento.status|lower }}">{{ orcamento.status }}</span>
  </div>

  <div class="card-block">
    <div class="row header-row">
      <div class="col-md-8 empresa">
        <h2>{{ empresa.nome_fantasia or "ELÉTRICA SAROBA & SOLAR" }}</h2>
        <small>CNPJ: {{ empresa.cnpj or "41.280.764/0001-65" }}</small>
        <small>{{ empresa.endereco or "RUA ERASMO DEMARTINI FOLTRAN, 541 - Tietê/SP - CEP 18530-000" }}</small>
        <small>{{ empresa.telefone or "(15) 3285-6121 / (15) 99670-2785" }}</small>
        <small>{{ empresa.email or "atendimento@eletricasaroba.com.br" }}</small>
        <small>{{ empresa.site or "www.eletricasaroba.com.br" }}</small>
      </div>
      <div class="col-md-4 contacts">
        <div><strong>Nº:</strong> {{ orcamento.codigo }}</div>
        <div><strong>Data:</strong> {{ orcamento.data.strftime("%d/%m/%Y") }}</div>
        <div><strong>Validade:</strong> {{ orcamento.validade }} dias</div>
        {% if orcamento.previsao_entrega %}
          <div><strong>Previsão de Entrega:</strong> {{ orcamento.previsao_entrega.strftime("%d/%m/%Y") }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Cliente -->
    <h3 class="section-title">Dados do Cliente</h3>
    <div class="kv">
      <div><strong>Razão Social / Nome:</strong></div><div>{{ cliente.nome }}</div>
      {% if cliente.fantasia %}<div><strong>Nome Fantasia:</strong></div><div>{{ cliente.fantasia }}</div>{% endif %}
      <div><strong>CNPJ/CPF:</strong></div><div>{{ cliente.documento }}</div>
      <div><strong>Endereço:</strong></div><div>{{ cliente.endereco_completo }}</div>
      <div><strong>Contato:</strong></div><div>{{ cliente.telefone }} {% if cliente.email %}- {{ cliente.email }}{% endif %}</div>
    </div>

    <!-- Serviços -->
    {% set tem_servicos = servicos and servicos|length > 0 %}
    {% if tem_servicos %}
      <h3 class="section-title">Serviços</h3>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:50px">Item</th>
              <th>Descrição</th>
              <th class="text-end" style="width:110px">Qtd.</th>
              <th class="text-end" style="width:140px">Vlr. Unit. (R$)</th>
              <th class="text-end" style="width:160px">Subtotal (R$)</th>
            </tr>
          </thead>
          <tbody>
            {% for s in servicos %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ s.descricao }}</td>
              <td class="text-end">{{ "%.2f"|format(s.qtd or 1) }}</td>
              <td class="text-end">{{ "%.2f"|format(s.valor_unit) }}</td>
              <td class="text-end">{{ "%.2f"|format(s.qtd * s.valor_unit) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <!-- Produtos -->
    {% set tem_produtos = produtos and produtos|length > 0 %}
    {% if tem_produtos %}
      <h3 class="section-title">Produtos</h3>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:50px">Item</th>
              <th>Produto</th>
              <th class="text-end" style="width:110px">Qtd.</th>
              <th class="text-end" style="width:140px">Vlr. Unit. (R$)</th>
              <th class="text-end" style="width:160px">Subtotal (R$)</th>
            </tr>
          </thead>
          <tbody>
            {% for p in produtos %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ p.nome }}</td>
              <td class="text-end">{{ "%.2f"|format(p.qtd or 1) }}</td>
              <td class="text-end">{{ "%.2f"|format(p.valor_unit) }}</td>
              <td class="text-end">{{ "%.2f"|format(p.qtd * p.valor_unit) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <!-- Totais -->
    <h3 class="section-title">Resumo Financeiro</h3>
    <div class="row totais">
      <div class="col-md-6">
        <div class="mb-2">
          <div class="lbl">Condição de Pagamento</div>
          <div class="val">
            {{ condicao.descricao if condicao else "—" }}
            {% if condicao and condicao.parcelas > 1 %}
              • {{ condicao.parcelas }}x
            {% endif %}
            {% if condicao and condicao.desconto %} • Desconto: {{ "%.2f"|format(condicao.desconto) }}%{% endif %}
            {% if condicao and condicao.juros %} • Juros: {{ "%.2f"|format(condicao.juros) }}%{% endif %}
          </div>
          {% if calendario and calendario|length>0 %}
            <div class="mt-1">
              <small class="text-muted">Vencimentos:</small>
              <ul class="mb-0">
                {% for par in calendario %}
                  <li><small>{{ loop.index }}ª: {{ par.data.strftime("%d/%m/%Y") }} • R$ {{ "%.2f"|format(par.valor) }} ({{ par.forma or "A combinar" }})</small></li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between"><span class="lbl">Subtotal Serviços</span><span class="val">R$ {{ "%.2f"|format(total_servicos or 0) }}</span></div>
        <div class="d-flex justify-content-between"><span class="lbl">Subtotal Produtos</span><span class="val">R$ {{ "%.2f"|format(total_produtos or 0) }}</span></div>
        {% if descontos and descontos>0 %}
          <div class="d-flex justify-content-between"><span class="lbl">Descontos</span><span class="val">- R$ {{ "%.2f"|format(descontos) }}</span></div>
        {% endif %}
        {% if acrescimos and acrescimos>0 %}
          <div class="d-flex justify-content-between"><span class="lbl">Acréscimos</span><span class="val">+ R$ {{ "%.2f"|format(acrescimos) }}</span></div>
        {% endif %}
        <hr class="my-2">
        <div class="d-flex justify-content-between fs-5">
          <strong>Total Geral</strong>
          <strong>R$ {{ "%.2f"|format(orcamento.valor_total) }}</strong>
        </div>
      </div>
    </div>

    <!-- Observações -->
    {% if orcamento.observacoes %}
      <h3 class="section-title">Observações</h3>
      <div class="observacoes">{{ orcamento.observacoes }}</div>
    {% endif %}

    <!-- Dados de Pagamento (Pix/Conta) -->
    {% if empresa.pix or empresa.banco %}
      <h3 class="section-title">Dados para Pagamento</h3>
      <div class="row">
        <div class="col-md-8">
          <div class="kv">
            {% if empresa.banco %}
              <div><strong>Banco:</strong></div><div>{{ empresa.banco }}</div>
              <div><strong>Agência:</strong></div><div>{{ empresa.agencia }}</div>
              <div><strong>Conta:</strong></div><div>{{ empresa.conta }}</div>
              <div><strong>Titular:</strong></div><div>{{ empresa.titular }}</div>
              <div><strong>Documento:</strong></div><div>{{ empresa.doc_titular }}</div>
            {% endif %}
            {% if empresa.pix %}
              <div><strong>Pix:</strong></div><div>{{ empresa.pix }}</div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4 text-center">
          {% if empresa.qr_pix_base64 %}
            <img src="data:image/png;base64,{{ empresa.qr_pix_base64 }}" alt="QR Pix" class="img-fluid" style="max-height:140px;">
            <div><small class="text-muted">Escaneie para pagar</small></div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <!-- Termos e Assinaturas -->
    <h3 class="section-title">Termos</h3>
    <div class="termos">
      <small>
        1) Proposta válida por {{ orcamento.validade }} dias a contar da emissão. <br>
        2) Materiais e prazos sujeitos à disponibilidade do mercado. <br>
        3) Serviços executados conforme normas técnicas vigentes e escopo aprovado. <br>
        4) Garantias: conforme fabricante (materiais) e 90 dias (serviços), salvo convenção diversa. <br>
      </small>
    </div>

    <div class="row assinaturas">
      <div class="col-md-6 text-center">
        <div class="line"></div>
        <small>Assinatura do Cliente</small>
      </div>
      <div class="col-md-6 text-center">
        <div class="line"></div>
        <small>{{ empresa.titular or "Responsável – Elétrica Saroba & Solar" }}</small>
      </div>
    </div>

    <div class="text-end mt-3">
      <small class="text-muted">Gerado por ERP JSP – Elétrica Industrial</small>
    </div>
  </div>

  <div class="mt-3 no-print text-end">
    <button onclick="window.print()" class="btn btn-dark btn-sm">Imprimir</button>
  </div>
</div>
</body>
</html>
