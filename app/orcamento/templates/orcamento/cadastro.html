{% extends "base.html" %}
{% block titulo %}{{ 'Editar Orçamento' if orcamento else 'Novo Orçamento' }} — JSP ERP{% endblock %}

{% block content %}

<div class="page-title">
  <div class="ico"><i class="fas fa-file-invoice-dollar"></i></div>
  <h3 style="margin:0;">{{ 'Editar Orçamento' if orcamento else 'Cadastro de Orçamento' }}</h3>
</div>

<div class="card card-jsp shadow mb-4">
  <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-clipboard-list"></i>
      <strong>{{ 'Edição de Orçamento' if orcamento else 'Novo Orçamento' }}</strong>
      <span class="badge rounded-pill" style="background:rgba(41,182,255,.18);border:1px solid rgba(86,212,255,.28);color:#eaf6ff;">
        Nº {{ (orcamento.codigo if orcamento and orcamento.codigo else (codigo_preview if codigo_preview else '—')) }}
      </span>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-light btn-sm" style="border-color:rgba(255,255,255,.25)"
         href="{{ url_for('orcamento.listar_orcamentos') }}">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <div class="card-body">
    <form id="formOrcamento" method="POST" action="{{ url_for('orcamento.salvar_orcamento') }}">
      <!-- ===== Informações Básicas ===== -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-info-circle me-2"></i>Informações Básicas
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="cliente_id" class="form-label">Cliente *</label>
              <select class="form-select" id="cliente_id" name="cliente_id" required>
                <option value="" disabled selected>Selecione</option>
                {% for c in clientes %}
                  <option
                    value="{{ c.id }}"
                    data-razao="{{ c.nome or '' }}"
                    data-fantasia="{{ c.fantasia or c.apelido or '' }}"
                    data-doc="{{ c.cnpj or c.cpf or '' }}"
                    data-endereco="{{ c.endereco or c.logradouro or '' }}"
                    data-cidade="{{ c.cidade or '' }}"
                    data-uf="{{ c.uf or '' }}"
                    data-cep="{{ c.cep or '' }}"
                    data-telefone="{{ c.telefone or '' }}"
                    data-email="{{ c.email or '' }}"
                    {% if orcamento and orcamento.cliente_id == c.id %}selected{% endif %}
                  >{{ c.nome }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label for="data" class="form-label">Data *</label>
              <div class="input-group">
                <input type="date" class="form-control" id="data" name="data"
                       value="{{ (orcamento.data_criacao.strftime('%Y-%m-%d') if orcamento and orcamento.data_criacao) or (data_hoje or '') }}"
                       required>
                <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
              </div>
            </div>

            <div class="col-md-4">
              <label for="previsao_entrega" class="form-label">Previsão de Entrega</label>
              <input type="date" class="form-control" id="previsao_entrega" name="previsao_entrega"
                     value="{{ orcamento.previsao_entrega.strftime('%Y-%m-%d') if orcamento and orcamento.previsao_entrega else '' }}">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label for="vendedor" class="form-label">Vendedor</label>
              <input type="text" class="form-control" id="vendedor" name="vendedor"
                     value="{{ orcamento.vendedor if orcamento else '' }}"
                     placeholder="Ex.: Juliano Saroba Pereira">
            </div>

            <div class="col-md-4">
              <label for="validade" class="form-label">Validade (dias) *</label>
              <input type="number" class="form-control" id="validade" name="validade" min="1" step="1"
                     value="{{ orcamento.validade if orcamento and orcamento.validade else 7 }}" required>
            </div>

            <div class="col-md-4">
              <label for="status" class="form-label">Status *</label>
              {% set st = (orcamento.status if orcamento and orcamento.status else 'Pendente') %}
              <select class="form-select" id="status" name="status" required>
                <option value="Pendente" {{ 'selected' if st=='Pendente' else '' }}>Pendente</option>
                <option value="Aprovado" {{ 'selected' if st=='Aprovado' else '' }}>Aprovado</option>
                <option value="Recusado" {{ 'selected' if st=='Recusado' else '' }}>Recusado</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Pagamento & Total ===== -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-wallet me-2"></i>Condição de Pagamento & Total
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="condicao_pagamento_id" class="form-label">Condição de Pagamento *</label>
              <select class="form-select" id="condicao_pagamento_id" name="condicao_pagamento_id" required>
                <option value="" disabled {{ 'selected' if not orcamento }}>Selecione</option>
                {% for cond in condicoes %}
                  <option value="{{ cond.id }}"
                          {% if orcamento and orcamento.condicao_pagamento_id == cond.id %}selected{% endif %}>
                    {{ cond.descricao }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label for="valor_total" class="form-label">Valor Total *</label>
              <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="text" class="form-control" id="valor_total" name="valor_total"
                       placeholder="0,00" inputmode="decimal" required
                       value="{% if orcamento and orcamento.valor_total is not none %}{{ '%.2f'|format(orcamento.valor_total)|replace('.', ',') }}{% endif %}">
              </div>
              <div class="form-text">Digite apenas números. Ex.: 1.250,90</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Observações ===== -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-clipboard me-2"></i>Observações / Serviço Proposto
        </div>
        <div class="card-body">
          <textarea class="form-control" id="observacoes" name="observacoes" rows="5"
            placeholder="1) Descrever escopo do serviço conforme combinado...
2) Condições específicas...">{{ orcamento.observacoes if orcamento else '' }}</textarea>
        </div>
      </div>

      <!-- ===== Painel Dados do Cliente (read-only) ===== -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-id-badge me-2"></i>Dados do Cliente
        </div>
        <div class="card-body">
          <div class="row g-2 small">
            <div class="col-md-6"><strong>Razão social:</strong> <span id="cli_razao">—</span></div>
            <div class="col-md-6"><strong>Nome fantasia:</strong> <span id="cli_fantasia">—</span></div>
            <div class="col-md-6"><strong>CNPJ/CPF:</strong> <span id="cli_doc">—</span></div>
            <div class="col-md-6"><strong>E-mail:</strong> <span id="cli_email">—</span></div>
            <div class="col-md-8"><strong>Endereço:</strong> <span id="cli_end">—</span></div>
            <div class="col-md-2"><strong>Cidade/UF:</strong> <span id="cli_cidade_uf">—</span></div>
            <div class="col-md-2"><strong>CEP:</strong> <span id="cli_cep">—</span></div>
            <div class="col-md-4"><strong>Telefone:</strong> <span id="cli_tel">—</span></div>
          </div>
        </div>
      </div>

      <!-- Hidden JSONs para futuras linhas (produtos/serviços) -->
      <input type="hidden" name="servicos_json" id="servicos_json" value="{{ servicos_json or '[]' }}">
      <input type="hidden" name="produtos_json" id="produtos_json" value="{{ produtos_json or '[]' }}">

      <div class="d-flex justify-content-end gap-2">
        <a href="{{ url_for('orcamento.listar_orcamentos') }}" class="btn btn-outline-light"
           style="border-color:rgba(255,255,255,.25)"><i class="fas fa-times me-1"></i> Cancelar</a>
        <button type="submit" class="btn btn-brand"><i class="fas fa-save me-1"></i> Salvar Orçamento</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<style>
  /* Alinha contraste dos inputs/labels ao tema */
  .card-jsp .form-label, .card-jsp label { color: #eaf6ff; font-weight:700; }
  .card-jsp .form-control, .card-jsp .form-select{
    color:#eaf6ff; background: rgba(15,31,54,.55);
    border:1px solid rgba(255,255,255,.12);
  }
  .card-jsp .form-control::placeholder{ color:#9fb3d6; opacity:.9 }
  .card-jsp .input-group-text{
    color:#eaf6ff; background: rgba(41,182,255,.12); border-color: rgba(255,255,255,.12);
  }
</style>

<script>
(function(){
  // ===== Data padrão se vazia =====
  const inputData = document.getElementById('data');
  if (inputData && !inputData.value) {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    inputData.value = `${y}-${m}-${day}`;
  }

  // ===== Painel Dados do Cliente =====
  const selCliente = document.getElementById('cliente_id');
  const byId = (id)=>document.getElementById(id);

  function fillCliente(){
    const opt = selCliente?.options?.[selCliente.selectedIndex];
    if(!opt || !opt.dataset) return;
    byId('cli_razao').textContent       = opt.dataset.razao     || '—';
    byId('cli_fantasia').textContent    = opt.dataset.fantasia  || '—';
    byId('cli_doc').textContent         = opt.dataset.doc       || '—';
    byId('cli_end').textContent         = opt.dataset.endereco  || '—';
    const cidadeUF = ((opt.dataset.cidade||'') + '/' + (opt.dataset.uf||'')).replace(/^\//,'');
    byId('cli_cidade_uf').textContent   = cidadeUF || '—';
    byId('cli_cep').textContent         = opt.dataset.cep       || '—';
    byId('cli_tel').textContent         = opt.dataset.telefone  || '—';
    byId('cli_email').textContent       = opt.dataset.email     || '—';
  }
  selCliente && selCliente.addEventListener('change', fillCliente);
  // Pré-preenche caso venha selecionado
  if (selCliente && selCliente.value) fillCliente();

  // ===== Valor Total — mascara/normalização pt-BR =====
  const form  = document.getElementById('formOrcamento');
  const valor = document.getElementById('valor_total');

  function toNumberBR(v){
    if (!v) return NaN;
    // remove pontos de milhar e troca vírgula por ponto
    v = String(v).replace(/\./g, '').replace(',', '.');
    return Number(v);
  }

  valor && valor.addEventListener('blur', () => {
    const n = toNumberBR(valor.value);
    if (!isNaN(n)) {
      valor.value = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
  });

  form && form.addEventListener('submit', (e) => {
    const n = toNumberBR(valor.value);
    if (isNaN(n)) {
      e.preventDefault();
      alert('Valor Total inválido.');
      valor.focus();
      return false;
    }
    valor.value = n.toFixed(2); // backend recebe como 9999.99
  });
})();
</script>
{% endblock %}
