{% extends 'base.html' %}
{% block content %}
<div class="container my-4 relatorio-os">
    <div class="d-print-none mb-3">
        <a href="{{ url_for('os.listar_os') }}" class="btn btn-secondary">Voltar</a>
        <a href="{{ url_for('os.gerar_pdf', os_id=os.id) }}" class="btn btn-success" target="_blank">Gerar PDF</a>
    </div>
    
    <div class="row align-items-center mb-3">
        <div class="col-2 text-center">
            <img src="{{ url_for('static', filename='img/logotipo_jsp.png') }}" alt="Logo JSP" style="max-width:90px;max-height:90px;">
        </div>
        <div class="col-10">
            <h3 class="mb-0">ORDEM DE SERVIÇO Nº {{ os.codigo }}</h3>
            <div class="text-muted small">
                JSP ELÉTRICA INDUSTRIAL &amp; SOLAR<br>
                CNPJ: 41.280.764/0001-65<br>
                Rua Indalécio Costa, 890 - Barra Funda - Tietê/SP - CEP: 18532-122<br>
                Fone: (15)99670-2036 / (15)99802-5861
            </div>
        </div>
    </div>
    <hr>
    
    <h5 class="mt-3">Dados do Cliente</h5>
    <table class="table table-bordered table-sm mb-4">
        <tbody>
            <tr><th>Nome</th><td>{{ os.cliente.nome if os.cliente else 'N/A' }}</td></tr>
            <tr><th>CPF/CNPJ</th><td>{{ os.cliente.cpf_cnpj if os.cliente else 'N/A' }}</td></tr>
            <tr><th>Telefone</th><td>{{ os.cliente.telefone if os.cliente else 'N/A' }}</td></tr>
            <tr><th>E-mail</th><td>{{ os.cliente.email if os.cliente else 'N/A' }}</td></tr>
            <tr><th>Endereço</th><td>{{ os.cliente.endereco if os.cliente else 'N/A' }}</td></tr>
            {% if os.solicitante or os.contato %}
            <tr><th>Contato</th><td>{{ os.solicitante or os.contato or 'N/A' }}</td></tr>
            {% endif %}
        </tbody>
    </table>
    
    {% if os.equipamento_nome or os.equipamento_marca or os.equipamento_modelo or os.equipamento_numero_serie or os.equipamento_acessorios %}
    <h5>Equipamento</h5>
    <table class="table table-bordered table-sm mb-4">
        <tbody>
            {% if os.equipamento_nome %}<tr><th>Nome</th><td>{{ os.equipamento_nome }}</td></tr>{% endif %}
            {% if os.equipamento_marca %}<tr><th>Marca</th><td>{{ os.equipamento_marca }}</td></tr>{% endif %}
            {% if os.equipamento_modelo %}<tr><th>Modelo</th><td>{{ os.equipamento_modelo }}</td></tr>{% endif %}
            {% if os.equipamento_numero_serie %}<tr><th>Nº Série</th><td>{{ os.equipamento_numero_serie }}</td></tr>{% endif %}
            {% if os.equipamento_acessorios %}<tr><th>Acessórios</th><td>{{ os.equipamento_acessorios }}</td></tr>{% endif %}
        </tbody>
    </table>
    {% endif %}
    
    <h5>Serviços Realizados</h5>
    <table class="table table-bordered table-sm mb-4">
        <thead class="table-light">
            <tr>
                <th>Descrição do Serviço</th>
                <th>Horas</th>
                <th>Valor Unitário</th>
                <th>Valor Total</th>
            </tr>
        </thead>
        <tbody>
            {% set horas_trabalhadas = (os.total_horas or 1.0)|float %}
            <tr>
                <td>{{ os.servico.nome if os.servico else 'Manutenção Elétrica Industrial' }}</td>
                <td>{{ '%.2f'|format(horas_trabalhadas) }}h</td>
                <td>R$ {% if horas_trabalhadas > 0 %}{{ '%.2f'|format((os.valor_servicos|float or 0) / horas_trabalhadas) }}{% else %}{{ '%.2f'|format(os.servico.valor|float or 0) if os.servico else '0.00' }}{% endif %}</td>
                <td>R$ {{ '%.2f'|format(os.valor_servicos|default(0)|float) }}</td>
            </tr>
        </tbody>
    </table>
    
    {% if (produtos_dados and produtos_dados|length > 0) or (os.valor_produtos and os.valor_produtos > 0) %}
    <h5>Produtos Utilizados</h5>
    <table class="table table-bordered table-sm mb-4">
        <thead class="table-light">
            <tr>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Valor Unitário</th>
                <th>Valor Total</th>
            </tr>
        </thead>
        <tbody>
            {% if produtos_dados and produtos_dados|length > 0 %}
                {% for p in produtos_dados %}
                <tr>
                    <td>{{ p.nome }}</td>
                    <td>{{ p.quantidade }}</td>
                    <td>R$ {{ '%.2f'|format(p.valor_unitario|float) }}</td>
                    <td>R$ {{ '%.2f'|format(p.valor_total|float) }}</td>
                </tr>
                {% endfor %}
            {% else %}
                {% if os.valor_produtos and os.valor_produtos > 0 %}
                <tr>
                    <td>Produtos/Materiais utilizados no serviço</td>
                    <td>1</td>
                    <td>R$ {{ '%.2f'|format(os.valor_produtos|float) }}</td>
                    <td>R$ {{ '%.2f'|format(os.valor_produtos|float) }}</td>
                </tr>
                {% endif %}
            {% endif %}
        </tbody>
    </table>
    {% endif %}
    
    <h5>Condições de Pagamento</h5>
    <div class="row mb-3">
        <div class="col-md-6">
            <p><strong>Condições:</strong> {{ os.condicoes_pagamento or 'À vista' }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Forma de Pagamento:</strong> 
                {% if os.forma_pagamento %}
                    <span class="badge 
                        {% if os.forma_pagamento.lower() in ['pago', 'à vista', 'dinheiro', 'pix', 'cartão'] %}
                            bg-success
                        {% else %}
                            bg-warning
                        {% endif %}">
                        {{ os.forma_pagamento }}
                    </span>
                {% else %}
                    <span class="badge bg-secondary">Não definida</span>
                {% endif %}
            </p>
        </div>
    </div>
    <table class="table table-bordered table-sm mb-4">
        <thead class="table-light">
            <tr>
                <th>Vencimento</th>
                <th>Valor (R$)</th>
                <th>Situação</th>
            </tr>
        </thead>
        <tbody>
            {% if parcelas and parcelas|length > 0 %}
                {% for p in parcelas %}
                <tr>
                    <td>{{ p.data_vencimento or 'À Vista' }}</td>
                    <td>R$ {{ '%.2f'|format(p.valor|float) }}</td>
                    <td>{{ p.status or p.situacao or 'Em aberto' }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td>À Vista</td>
                    <td>R$ {{ '%.2f'|format(os.valor_total|float or 0) }}</td>
                    <td>Em aberto</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <h5>Resumo Financeiro</h5>
            <table class="table table-bordered table-sm">
                <tbody>
                    <tr class="table-info">
                        <th>Total Serviços</th>
                        <td><strong>R$ {{ '%.2f'|format((total_servicos or os.valor_servicos or 0)|float) }}</strong></td>
                    </tr>
                    <tr class="table-info">
                        <th>Total Produtos</th>
                        <td><strong>R$ {{ '%.2f'|format((total_produtos or os.valor_produtos or 0)|float) }}</strong></td>
                    </tr>
                    <tr class="table-success">
                        <th class="fw-bold">Total Geral</th>
                        <td class="fw-bold"><strong>R$ {{ '%.2f'|format((valor_total or os.valor_total or 0)|float) }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h5>Dados para Transferência</h5>
            <table class="table table-bordered table-sm">
                <tbody>
                    <tr><th>Banco</th><td>Bradesco</td></tr>
                    <tr><th>Agência</th><td>0367-6</td></tr>
                    <tr><th>Conta</th><td>0082598-4</td></tr>
                    <tr><th>CNPJ</th><td>41.280.764/0001-65</td></tr>
                    <tr><th>PIX</th><td><strong>41.280.764/0001-65</strong></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <h5>Técnico Responsável</h5>
            <div class="border p-3 bg-light">{{ os.tecnico_responsavel or 'Juliano Saroba Pereira' }}</div>
        </div>
        <div class="col-md-6">
            <h5>Problema Descrito</h5>
            <div class="border p-3 bg-light">{{ os.problema_descrito or 'Não informado' }}</div>
        </div>
    </div>
    
    {% if os.descricao_servico_realizado %}
    <div class="mb-4">
        <h5>Descrição do Serviço Realizado</h5>
        <div class="border p-3 bg-light">{{ os.descricao_servico_realizado }}</div>
    </div>
    {% endif %}
    
    {% if os.observacoes_tecnico or os.observacoes_cliente or os.outras_informacoes %}
    <div class="mb-4">
        <h5>Observações</h5>
        {% if os.observacoes_tecnico %}
        <div><strong>Técnico:</strong> {{ os.observacoes_tecnico }}</div>
        {% endif %}
        {% if os.observacoes_cliente %}
        <div><strong>Cliente:</strong> {{ os.observacoes_cliente }}</div>
        {% endif %}
        {% if os.outras_informacoes %}
        <div><strong>Outras informações:</strong> {{ os.outras_informacoes }}</div>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="row mt-5">
        <div class="col-md-6 text-center">
            <div style="border-top:1px solid #333; margin-top:40px; padding-top:5px;">
                <strong>Assinatura do Cliente</strong><br>
                <small class="text-muted">{{ os.cliente.nome if os.cliente else '' }}</small>
            </div>
        </div>
        <div class="col-md-6 text-center">
            <div style="border-top:1px solid #333; margin-top:40px; padding-top:5px;">
                <strong>Assinatura do Responsável</strong><br>
                <small class="text-muted">{{ os.tecnico_responsavel or 'Juliano Saroba Pereira' }}</small>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4 text-muted small">
        <hr>
        Documento gerado em {{ os.data_emissao.strftime('%d/%m/%Y') if os.data_emissao else 'Data não informada' }} - Sistema ERP JSP
    </div>
</div>

<style>
@media print {
    .d-print-none { display: none !important; }
    .relatorio-os { background: #fff !important; }
    .table { font-size: 11px; }
    h3, h5 { color: #222 !important; }
    .table-info { background-color: #e7f3ff !important; }
    .table-success { background-color: #d4edda !important; }
}
.table th, .table td { vertical-align: middle !important; }
.table th { background-color: #f8f9fa; }
.table-info { background-color: #e7f3ff; }
.table-success { background-color: #d4edda; }
</style>
{% endblock %}
