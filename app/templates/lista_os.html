
{% extends 'base.html' %}
{% block content %}


{% if erro %}
  <div style="background: #ffdddd; color: #a00; border: 2px solid #a00; padding: 20px; margin-bottom: 20px; font-size: 1.2em;">
    <strong>ERRO NO BACKEND:</strong><br>
    {{ erro }}
  </div>
{% endif %}

{% if get_flashed_messages() %}
  <div class="alert alert-danger">
    {% for msg in get_flashed_messages() %}
      <div>{{ msg }}</div>
    {% endfor %}
  </div>
{% endif %}

<style>
    .text-os {
        color: #fff !important;
    }
    .btn-os {
        background: linear-gradient(135deg, #19335A, #1e3c72);
        color: #fff;
        border: none;
        font-weight: 600;
    }
    .btn-os:hover, .btn-os:focus {
        background: linear-gradient(135deg, #1e3c72, #19335A);
        color: #fff;
    }
    .stats-card {
        background: linear-gradient(135deg, #19335A, #1e3c72);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 12px #19335A33;
        border: 1.5px solid #1e3c72;
    }
    .table th {
        background-color: #19335A;
        color: white;
        border: none;
    }
    .badge-status {
        padding: 0.4em 0.8em;
        border-radius: 0.35rem;
        font-size: 0.85em;
        font-weight: 500;
        background: #1e3c72;
        color: #fff;
    }
    .badge-prioridade {
        padding: 0.3em 0.6em;
        border-radius: 0.25rem;
        font-size: 0.8em;
        background: #19335A;
        color: #fff;
    }
    .valor-destaque {
        font-weight: bold;
        color: #19335A;
        font-size: 1.1em;
    }
    .btn-status {
        padding: 4px 8px;
        font-size: 0.8em;
        border-radius: 4px;
        background: #19335A;
        color: #fff;
        border: none;
    }
    .btn-status:hover {
        background: #1e3c72;
        color: #fff;
    }
    .btn-primary, .btn-outline-primary {
        border-color: #19335A;
        background-color: #19335A;
        color: #fff;
    }
    .btn-primary:hover, .btn-outline-primary:hover {
        background-color: #1e3c72;
        border-color: #1e3c72;
        color: #fff;
    }
    .btn-success, .btn-outline-success {
        border-color: #19335A;
        background-color: #19335A;
        color: #fff;
    }
    .btn-success:hover, .btn-outline-success:hover {
        background-color: #1e3c72;
        border-color: #1e3c72;
        color: #fff;
    }
</style>

<div class="container mt-4">
        <!-- Estatísticas -->
        <div class="row">
            <div class="col-md-2-4">
                <div class="stats-card text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h4>{{ total_os|default(0) }}</h4>
                    <p class="mb-0">Total de OS</p>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stats-card text-center">
                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                    <h4>{{ os_abertas|default(0) }}</h4>
                    <p class="mb-0">Abertas</p>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stats-card text-center">
                    <i class="fas fa-cogs fa-2x mb-2"></i>
                    <h4>{{ os_andamento|default(0) }}</h4>
                    <p class="mb-0">Em Andamento</p>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stats-card text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h4>{{ os_concluidas|default(0) }}</h4>
                    <p class="mb-0">Concluídas</p>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stats-card text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h4>R$ {{ "%.2f"|format(valor_total|default(0)) }}</h4>
                    <p class="mb-0">Valor Total</p>
                </div>
            </div>
        </div>

        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-os">
                <i class="fas fa-tools"></i> Ordens de Serviço
            </h3>
            <a href="{{ url_for('os.nova_os') }}" class="btn btn-os">
                <i class="fas fa-plus"></i> Nova OS
            </a>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <select class="form-select" id="filtroStatus">
                            <option value="">Todos os Status</option>
                            <option value="Aberta">Aberta</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Concluída">Concluída</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filtroPrioridade">
                            <option value="">Todas as Prioridades</option>
                            <option value="Baixa">Baixa</option>
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="pesquisar" placeholder="Pesquisar por código, cliente ou técnico...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Ordens de Serviço -->
            
        {% if ordens is defined and ordens and ordens|length > 0 %}
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabelaOS">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Cliente</th>
                                <th>Solicitante</th>
                                <th>Contato</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Prioridade</th>
                                <th>Técnico</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th width="180">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for os in ordens|default([]) %}
                            <tr data-status="{{ os.status }}" data-prioridade="{{ os.prioridade }}">
                                <td>
                                    <strong class="text-primary">{{ os.codigo|default('') }}</strong>
                                </td>
                                <td>
                                        <strong>
                                            {% if os.cliente and os.cliente.nome %}
                                                {{ os.cliente.nome }}
                                            {% else %}
                                                Cliente ID: {{ os.cliente_id }}
                                            {% endif %}
                                        </strong>
                                </td>
                                <td>
                                    <small>{{ '' if not os.solicitante or os.solicitante in ['-', 'None', None] else os.solicitante|default('') }}</small>
                                </td>
                                <td>
                                    <small class="contato-mascarado">{{ '' if not os.contato or os.contato in ['-', 'None', None] else os.contato|default('') }}</small>
                                </td>

                                <td>
                                    <small class="text-muted">{{ os.tipo_servico|default('-') }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-status {{ os.get_status_badge_class() if os.get_status_badge_class is defined else '' }}">
                                        {{ os.status|default('') }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-prioridade {{ os.get_prioridade_badge_class() if os.get_prioridade_badge_class is defined else '' }}">
                                        {{ os.prioridade|default('') }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ os.tecnico_responsavel|default('-') }}</small>
                                </td>
                                <td>
                                    <small>{{ os.data_emissao.strftime('%d/%m/%Y') if os.data_emissao is defined and os.data_emissao else '-' }}</small>
                                </td>
                                <td>
                                    <span class="valor-destaque">R$ {{ "%.2f"|format(os.valor_total|default(0)) }}</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('os.editar_os', id=os.id|default(0)) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    
                                    <a href="{{ url_for('os.visualizar_os', id=os.id|default(0)) }}" 
                                       class="btn btn-sm btn-outline-info" title="Visualizar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                                                       
                                    <a href="{{ url_for('os.gerar_pdf', os_id=os.id|default(0)) }}" 
                                       class="btn btn-sm btn-outline-danger" title="Visualizar PDF" target="_blank"
                                       onclick="console.log('DEBUG: DASHBOARD Visualizar OS clicado para OS ID: {{ os.id }}')">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    
                                                                        
                                    <!-- Botões de mudança rápida de status -->
                                    {% if os.status|default('') == 'Aberta' %}
                                    <button class="btn btn-sm btn-warning btn-status" 
                                            onclick="alterarStatus('{{ os.id }}', 'Em Andamento')" 
                                            title="Iniciar">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    {% elif os.status|default('') == 'Em Andamento' %}
                                    <button class="btn btn-sm btn-success btn-status" 
                                            onclick="alterarStatus({{ os.id }}, 'Concluída')" 
                                            title="Concluir">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <form method="POST" action="{{ url_for('os.deletar_os', id=os.id) }}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('Tem certeza que deseja excluir esta OS?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Estado vazio -->
        <div class="text-center py-5">
            <i class="fas fa-tools fa-5x text-muted mb-3"></i>
            <h4 class="text-muted">Nenhuma ordem de serviço cadastrada</h4>
            <p class="text-muted mb-4">Comece criando sua primeira ordem de serviço</p>
            <a href="{{ url_for('os.nova_os') }}" class="btn btn-success btn-lg">
                <i class="fas fa-plus"></i> Criar Primeira OS
            </a>
        </div>
        {% endif %}

        <!-- Rodapé -->
        <div class="text-center mt-4">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Total de {{ total_os|default(0) }} ordens de serviço cadastradas
            </small>
        </div>
    </div>

<script>
        // Filtros
        function filtrarTabela() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroPrioridade = document.getElementById('filtroPrioridade').value;
            const pesquisa = document.getElementById('pesquisar').value.toLowerCase();
            
            const linhas = document.querySelectorAll('#tabelaOS tbody tr');
            
            linhas.forEach(linha => {
                const status = linha.getAttribute('data-status');
                const prioridade = linha.getAttribute('data-prioridade');
                const texto = linha.textContent.toLowerCase();
                
                let mostrar = true;
                
                // Filtro por status
                if (filtroStatus && status !== filtroStatus) {
                    mostrar = false;
                }
                
                // Filtro por prioridade
                if (filtroPrioridade && prioridade !== filtroPrioridade) {
                    mostrar = false;
                }
                
                // Filtro por pesquisa
                if (pesquisa && !texto.includes(pesquisa)) {
                    mostrar = false;
                }
                
                linha.style.display = mostrar ? '' : 'none';
            });
        }

        
        function limparFiltros() {
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroPrioridade').value = '';
            document.getElementById('pesquisar').value = '';
            filtrarTabela();
        }
        
        // Event listeners
        document.getElementById('filtroStatus').addEventListener('change', filtrarTabela);
        document.getElementById('filtroPrioridade').addEventListener('change', filtrarTabela);
        document.getElementById('pesquisar').addEventListener('input', filtrarTabela);
        
        // Função para alterar status rapidamente
        function alterarStatus(osId, novoStatus) {
            if (confirm(`Alterar status para "${novoStatus}"?`)) {
                // Criar formulário para enviar via POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/os/${osId}/alterar-status`;
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = novoStatus;
                
                form.appendChild(statusInput);
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // CSS customizado para grid com 5 colunas
        const style = document.createElement('style');
        style.textContent = `
            .col-md-2-4 {
                flex: 0 0 auto;
                width: 20%;
            }
            @media (max-width: 768px) {
                .col-md-2-4 {
                    width: 50%;
                    margin-bottom: 1rem;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
{% endblock %}
