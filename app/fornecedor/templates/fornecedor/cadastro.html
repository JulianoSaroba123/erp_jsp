{% extends 'base.html' %}
{% block titulo %}{{ 'Editar Fornecedor' if fornecedor else 'Cadastro de Fornecedor' }} — JSP ERP{% endblock %}

{% block content %}

<div class="page-title">
  <div class="ico"><i class="fas fa-truck"></i></div>
  <h3 style="margin:0;">{{ 'Editar Fornecedor' if fornecedor else 'Cadastro de Fornecedor' }}</h3>
</div>

<form method="POST" novalidate>
  <!-- Header / Contexto -->
  <div class="card card-jsp mb-3">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <i class="fas fa-truck-loading"></i>
        <strong>{{ 'Edição de Fornecedor' if fornecedor else 'Novo Fornecedor' }}</strong>
        {% if fornecedor and fornecedor.codigo %}
          <code>{{ fornecedor.codigo }}</code>
        {% endif %}
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-light btn-sm" style="border-color:rgba(255,255,255,.25)"
           href="{{ url_for('fornecedor.listar_fornecedores') }}">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <!-- Informações Principais -->
  <div class="card card-jsp mb-4">
    <div class="card-header">
      <i class="fas fa-info-circle me-2"></i>Informações Principais
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label for="cpf_cnpj" class="form-label" id="label_cpf_cnpj">CPF / CNPJ *</label>
          <input type="text" id="cpf_cnpj" name="cpf_cnpj" class="form-control" required
                 value="{{ fornecedor.cpf_cnpj if fornecedor else '' }}" autocomplete="off">
          <small class="text-muted" id="hint_cpf_cnpj">Aceita CPF (###.###.###-##) ou CNPJ (##.###.###/####-##)</small>
        </div>
        <div class="col-md-9 mb-3">
          <label for="nome" class="form-label" id="label_nome">Nome / Razão Social *</label>
          <input type="text" id="nome" name="nome" class="form-control" required
                 value="{{ fornecedor.nome if fornecedor else '' }}">
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="apelido" class="form-label">Apelido / Nome Fantasia</label>
          <input type="text" id="apelido" name="apelido" class="form-control"
                 value="{{ fornecedor.apelido if fornecedor else '' }}">
        </div>
        <div class="col-md-3 mb-3">
          <label for="telefone" class="form-label">Telefone *</label>
          <input type="text" id="telefone" name="telefone" class="form-control" required
                 value="{{ fornecedor.telefone if fornecedor else '' }}" autocomplete="off">
        </div>
        <div class="col-md-3 mb-3">
          <label for="email" class="form-label">E-mail</label>
          <input type="email" id="email" name="email" class="form-control"
                 value="{{ fornecedor.email if fornecedor else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Endereço -->
  <div class="card card-jsp mb-4">
    <div class="card-header">
      <i class="fas fa-map-marker-alt me-2"></i>Endereço
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label for="cep" class="form-label">CEP</label>
          <input type="text" id="cep" name="cep" class="form-control" maxlength="9"
                 value="{{ fornecedor.cep if fornecedor else '' }}" autocomplete="off">
          <small class="text-muted">Formato: 00000-000</small>
          <div class="info-cep mt-2" style="display:none;"></div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="logradouro" class="form-label">Logradouro</label>
          <input type="text" id="logradouro" name="logradouro" class="form-control"
                 value="{{ fornecedor.logradouro if fornecedor else '' }}">
        </div>
        <div class="col-md-3 mb-3">
          <label for="numero" class="form-label">Número</label>
          <input type="text" id="numero" name="numero" class="form-control"
                 value="{{ fornecedor.numero if fornecedor else '' }}">
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="complemento" class="form-label">Complemento</label>
          <input type="text" id="complemento" name="complemento" class="form-control"
                 value="{{ fornecedor.complemento if fornecedor else '' }}">
        </div>
        <div class="col-md-4 mb-3">
          <label for="bairro" class="form-label">Bairro</label>
          <input type="text" id="bairro" name="bairro" class="form-control"
                 value="{{ fornecedor.bairro if fornecedor else '' }}">
        </div>
        <div class="col-md-4 mb-3">
          <label for="cidade" class="form-label">Cidade</label>
          <input type="text" id="cidade" name="cidade" class="form-control"
                 value="{{ fornecedor.cidade if fornecedor else '' }}">
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">
          <label for="uf" class="form-label">UF</label>
          <select id="uf" name="uf" class="form-select">
            {% set UF = fornecedor.uf if fornecedor else '' %}
            {% for s in [
              'AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'
            ] %}
              <option value="{{ s }}" {% if UF==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Informações Comerciais -->
  <div class="card card-jsp mb-4">
    <div class="card-header">
      <i class="fas fa-handshake me-2"></i>Informações Comerciais
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="inscricao_estadual" class="form-label">Inscrição Estadual</label>
          <input type="text" id="inscricao_estadual" name="inscricao_estadual" class="form-control"
                 value="{{ fornecedor.inscricao_estadual if fornecedor else '' }}">
        </div>
        <div class="col-md-4 mb-3">
          <label for="inscricao_municipal" class="form-label">Inscrição Municipal</label>
          <input type="text" id="inscricao_municipal" name="inscricao_municipal" class="form-control"
                 value="{{ fornecedor.inscricao_municipal if fornecedor else '' }}">
        </div>
        <div class="col-md-4 mb-3">
          <label for="email_comercial" class="form-label">E-mail Comercial</label>
          <input type="email" id="email_comercial" name="email_comercial" class="form-control"
                 value="{{ fornecedor.email_comercial if fornecedor else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Observações -->
  <div class="card card-jsp mb-4">
    <div class="card-header">
      <i class="fas fa-clipboard me-2"></i>Observações
    </div>
    <div class="card-body">
      <label for="observacoes" class="form-label">Observações</label>
      <textarea id="observacoes" name="observacoes" class="form-control" rows="3">{{ fornecedor.observacoes if fornecedor else '' }}</textarea>
    </div>
  </div>

  <div class="text-end">
    <button type="submit" class="btn btn-brand btn-lg">
      <i class="fas fa-save"></i> {{ 'Atualizar Fornecedor' if fornecedor else 'Salvar Fornecedor' }}
    </button>
    <a href="{{ url_for('fornecedor.listar_fornecedores') }}" class="btn btn-outline-light btn-lg ms-2" style="border-color:rgba(255,255,255,.25)">
      <i class="fas fa-arrow-left"></i> Voltar
    </a>
  </div>
</form>

{% endblock %}

{% block scripts %}
  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

  <script>
  $(function () {
    /* ===== Máscaras ===== */
    // Telefone (celular BR)
    $('#telefone').mask('(00) 00000-0000');

    // CPF/CNPJ dinâmico
    function aplicarMaskCpfCnpj(valor){
      const digits = (valor || '').replace(/\D/g,'');
      if (digits.length > 11) {
        $('#cpf_cnpj').mask('00.000.000/0000-00'); // CNPJ
      } else {
        $('#cpf_cnpj').mask('000.000.000-00'); // CPF
      }
    }
    aplicarMaskCpfCnpj($('#cpf_cnpj').val());
    $('#cpf_cnpj').on('input', function(){ aplicarMaskCpfCnpj(this.value); });

    // CEP
    $('#cep').mask('00000-000');

    /* ===== ViaCEP ===== */
    function preencherEnderecoViaCEP(cepDigits){
      if (cepDigits.length !== 8) return;
      $('.info-cep').show().html('<i class="fas fa-spinner fa-spin"></i> Buscando CEP...');
      $.getJSON(`https://viacep.com.br/ws/${cepDigits}/json/`)
        .done(function(d){
          if (!d.erro){
            $('#logradouro').val(d.logradouro || '');
            $('#bairro').val(d.bairro || '');
            $('#cidade').val(d.localidade || '');
            $('#uf').val(d.uf || '');
            $('#numero').focus();
            $('.info-cep').html('<i class="fas fa-check-circle text-success"></i> Endereço carregado!');
          } else {
            $('.info-cep').html('<i class="fas fa-exclamation-triangle text-warning"></i> CEP não encontrado.');
          }
        })
        .fail(function(){
          $('.info-cep').html('<i class="fas fa-exclamation-triangle text-warning"></i> Erro ao consultar CEP.');
        });
    }
    $('#cep').on('blur', function(){
      preencherEnderecoViaCEP($(this).val().replace(/\D/g,''));
    });

    /* ===== BrasilAPI (CNPJ) ===== */
    $('#cpf_cnpj').on('blur', function(){
      const digits = $(this).val().replace(/\D/g,'');
      if (digits.length === 14){ // CNPJ
        $('.info-cep').show().html('<i class="fas fa-spinner fa-spin"></i> Buscando dados do CNPJ...');
        $.getJSON(`https://brasilapi.com.br/api/cnpj/v1/${digits}`)
          .done(function(d){
            if (d && !d.message){
              // Razão social
              if (!$('#nome').val()) $('#nome').val(d.razao_social || '');
              // Telefone
              if (d.ddd_telefone_1 && !$('#telefone').val()){
                const tel = d.ddd_telefone_1.replace(/\D/g,'');
                const fmt = tel.length > 10 ? '(00) 00000-0000' : '(00) 0000-0000';
                $('#telefone').unmask().mask(fmt).val(tel);
              }
              // Endereço
              if (d.cep){
                const c = d.cep.replace(/\D/g,'');
                $('#cep').val(c).trigger('blur');
              }
              $('.info-cep').html('<i class="fas fa-check-circle text-success"></i> Dados do CNPJ carregados!');
            } else {
              $('.info-cep').html('<i class="fas fa-exclamation-triangle text-warning"></i> CNPJ não encontrado.');
            }
          })
          .fail(function(){
            $('.info-cep').html('<i class="fas fa-exclamation-triangle text-warning"></i> Erro ao consultar CNPJ.');
          });
      }
    });

    /* ===== Validação simples ===== */
    $('form').on('submit', function(e){
      const nome = $('#nome').val().trim();
      const doc  = $('#cpf_cnpj').val().trim();
      const tel  = $('#telefone').val().trim();
      if (!nome){ alert('Nome/Razão é obrigatório.'); $('#nome').focus(); return e.preventDefault(); }
      if (!doc){  alert('CPF/CNPJ é obrigatório.');    $('#cpf_cnpj').focus(); return e.preventDefault(); }
      if (!tel){  alert('Telefone é obrigatório.');    $('#telefone').focus(); return e.preventDefault(); }
    });
  });
  </script>
{% endblock %}
