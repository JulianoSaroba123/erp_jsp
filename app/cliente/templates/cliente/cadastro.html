{% extends 'base.html' %}
<!-- TEMPLATE AVAN√áADO ATUALIZADO - RENDER FORCE UPDATE 26/08/2025 14:30 -->
<!-- Template de Cadastro Avan√ßado v3.0 - NOVO DEPLOY -->
{% block content %}
<style>
    form .form-control, form .form-select {
        border: 2px solid #0074d9;
        border-radius: 6px;
        box-shadow: none;
        transition: all 0.3s ease-in-out;
    }
    form .form-control:focus, form .form-select:focus {
        border-color: #005fa3;
        box-shadow: 0 0 0 0.2rem rgba(0, 116, 217, 0.15);
    }
    .card {
        border: 2px solid #0074d9;
        border-radius: 8px;
    }
    label {
        font-weight: 600;
    }
    .secao-formulario {
        background: linear-gradient(135deg, #e8f5ff, #f0f9ff);
        border: 2px solid #0074d9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    .info-cep {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.9em;
    }
    .tipo-pessoa-switch {
        background: #f8f9fa;
        border: 2px solid #0074d9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>

<div class="container mt-4">
    <div class="card shadow p-4">
        <h4 class="mb-4 text-success">
            <i class="fas fa-users"></i> 
            {{ 'Editar Cliente' if cliente else 'üöÄ NOVO TEMPLATE AVAN√áADO - CLIENTE' }}
        </h4>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form method="POST">
            <!-- Tipo de Pessoa -->
            <div class="tipo-pessoa-switch">
                <h6 class="text-success mb-3"><i class="fas fa-id-card"></i> Tipo de Pessoa</h6>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo_pessoa" id="tipo_pf" value="PF" {{ 'checked' if not cliente or (cliente and cliente.cpf_cnpj and cliente.cpf_cnpj|length <= 14) else '' }}>
                    <label class="form-check-label" for="tipo_pf">
                        <i class="fas fa-user"></i> Pessoa F√≠sica (CPF)
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="tipo_pessoa" id="tipo_pj" value="PJ" {{ 'checked' if cliente and cliente.cpf_cnpj and cliente.cpf_cnpj|length > 14 else '' }}>
                    <label class="form-check-label" for="tipo_pj">
                        <i class="fas fa-building"></i> Pessoa Jur√≠dica (CNPJ)
                    </label>
                </div>
            </div>
            <!-- Informa√ß√µes Principais -->
            <div class="row">
                <div class="col-12 mb-3">
                    <h5 class="text-primary"><i class="fas fa-info-circle"></i> Informa√ß√µes Principais</h5>
                    <hr>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="cpf_cnpj" id="label_cpf_cnpj">CPF / CNPJ *</label>
                    <input type="text" id="cpf_cnpj" name="cpf_cnpj" class="form-control" required maxlength="18" value="{{ cliente.cpf_cnpj if cliente else '' }}">
                    <small class="text-muted" id="hint_cpf_cnpj">Digite apenas n√∫meros</small>
                </div>
                <div class="col-md-8 mb-3">
                    <label for="nome" id="label_nome">Nome / Raz√£o Social *</label>
                    <input type="text" id="nome" name="nome" class="form-control" value="{{ cliente.nome if cliente else '' }}" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="telefone">Telefone *</label>
                    <input type="text" id="telefone" name="telefone" class="form-control" value="{{ cliente.telefone if cliente else '' }}" required>
                </div>
                <div class="col-md-9 mb-3">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" class="form-control" value="{{ cliente.email if cliente else '' }}">
                </div>
            </div>

            <!-- Endere√ßo -->
            <div class="secao-formulario">
                <h5 class="text-warning mb-3"><i class="fas fa-map-marker-alt"></i> Endere√ßo</h5>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="endereco">Endere√ßo Completo</label>
                        <textarea id="endereco" name="endereco" class="form-control" rows="3" placeholder="Digite o endere√ßo completo">{{ cliente.endereco if cliente else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ativo" name="ativo" {{ 'checked' if not cliente or cliente.ativo else '' }}>
                        <label class="form-check-label" for="ativo">
                            Cliente Ativo
                        </label>
                    </div>
                </div>
            </div>

            <div class="text-end mt-3">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i>
                    {{ 'Atualizar Cliente' if cliente else 'Salvar Cliente' }}
                </button>
                <a href="{{ url_for('cliente.listar_clientes') }}" class="btn btn-secondary btn-lg ms-2">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- jQuery Mask Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    $(document).ready(function () {
        // Fun√ß√£o para alternar entre CPF e CNPJ
        function alternarTipoPessoa(limparCampo = true) {
            const tipoPessoa = $('input[name="tipo_pessoa"]:checked').val();
            
            if (tipoPessoa === 'PF') {
                $('#cpf_cnpj').mask('000.000.000-00');
                $('#label_cpf_cnpj').text('CPF *');
                $('#label_nome').text('Nome Completo *');
                $('#hint_cpf_cnpj').text('Digite apenas n√∫meros do CPF');
            } else {
                $('#cpf_cnpj').mask('00.000.000/0000-00');
                $('#label_cpf_cnpj').text('CNPJ *');
                $('#label_nome').text('Raz√£o Social *');
                $('#hint_cpf_cnpj').text('Digite apenas n√∫meros do CNPJ');
            }
            
            // S√≥ limpar o campo se for uma mudan√ßa manual do usu√°rio
            if (limparCampo) {
                $('#cpf_cnpj').val('').focus();
            }
        }

        // Aplicar m√°scaras iniciais
        $('#telefone').mask('(00) 00000-0000');
        
        // Inicializar tipo de pessoa sem limpar o campo (para preservar dados na edi√ß√£o)
        alternarTipoPessoa(false);

        // Evento para mudan√ßa de tipo de pessoa (aqui sim limpa o campo)
        $('input[name="tipo_pessoa"]').change(function() {
            alternarTipoPessoa(true);
        });

        // Buscar dados de CNPJ usando BrasilAPI
        $('#cpf_cnpj').blur(function() {
            const documento = $(this).val().replace(/\D/g, '');
            const tipoPessoa = $('input[name="tipo_pessoa"]:checked').val();
            
            if (tipoPessoa === 'PJ' && documento.length === 14) {
                $.ajax({
                    url: `https://brasilapi.com.br/api/cnpj/v1/${documento}`,
                    method: 'GET',
                    success: function(data) {
                        if (!data.message) {
                            $('#nome').val(data.razao_social || '');
                            $('#telefone').val(data.ddd_telefone_1 || '');
                            $('#email').val(data.email || '');
                            
                            // Montar endere√ßo completo
                            let endereco = '';
                            if (data.logradouro) endereco += data.logradouro;
                            if (data.numero) endereco += ', ' + data.numero;
                            if (data.bairro) endereco += ' - ' + data.bairro;
                            if (data.municipio) endereco += ' - ' + data.municipio;
                            if (data.uf) endereco += '/' + data.uf;
                            if (data.cep) endereco += ' - CEP: ' + data.cep;
                            
                            $('#endereco').val(endereco);
                            
                            alert('Dados do CNPJ carregados automaticamente!');
                        }
                    },
                    error: function() {
                        alert('CNPJ n√£o encontrado ou inv√°lido');
                    }
                });
            }
        });

        // Valida√ß√£o de formul√°rio
        $('form').on('submit', function(e) {
            const nome = $('#nome').val().trim();
            const cpfCnpj = $('#cpf_cnpj').val().trim();
            const telefone = $('#telefone').val().trim();

            if (!nome) {
                alert('Nome √© obrigat√≥rio!');
                $('#nome').focus();
                e.preventDefault();
                return false;
            }

            if (!cpfCnpj) {
                alert('CPF/CNPJ √© obrigat√≥rio!');
                $('#cpf_cnpj').focus();
                e.preventDefault();
                return false;
            }

            if (!telefone) {
                alert('Telefone √© obrigat√≥rio!');
                $('#telefone').focus();
                e.preventDefault();
                return false;
            }
        });
    });
</script>

{% endblock %}
