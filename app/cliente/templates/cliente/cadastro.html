{% extends 'base.html' %}
{% block titulo %}{{ 'Editar Cliente' if cliente else 'Cadastro de Cliente' }} — JSP ERP{% endblock %}
{% block content %}

<div class="page-title">
  <div class="ico"><i class="fas fa-user-plus"></i></div>
  <h3 style="margin:0;">{{ 'Editar Cliente' if cliente else 'Cadastro de Cliente' }}</h3>
</div>

<div class="card card-jsp mb-3">
  <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-user-cog"></i>
      <strong>{{ 'Edição de Cliente' if cliente else 'Novo Cliente' }}</strong>
      {% if cliente %}
        <code>{{ cliente.codigo or ('CLI%05d' % cliente.id) }}</code>
      {% endif %}
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('cliente.listar_clientes') }}">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <div class="card-body">
    <form method="POST">
      
      <!-- Tipo de Pessoa -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-id-card me-2"></i>Tipo de Pessoa
        </div>
        <div class="card-body">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_pessoa" id="tipo_pf" value="PF" 
                   {{ 'checked' if not cliente or (cliente and cliente.cpf_cnpj and cliente.cpf_cnpj|length <= 14) else '' }}>
            <label class="form-check-label" for="tipo_pf">
              <i class="fas fa-user me-1"></i> Pessoa Física (CPF)
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_pessoa" id="tipo_pj" value="PJ" 
                   {{ 'checked' if cliente and cliente.cpf_cnpj and cliente.cpf_cnpj|length > 14 else '' }}>
            <label class="form-check-label" for="tipo_pj">
              <i class="fas fa-building me-1"></i> Pessoa Jurídica (CNPJ)
            </label>
          </div>
        </div>
      </div>

      <!-- Informações Principais -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-info-circle me-2"></i>Informações Principais
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="cpf_cnpj" class="form-label" id="label_cpf_cnpj">CPF / CNPJ *</label>
              <input type="text" id="cpf_cnpj" name="cpf_cnpj" class="form-control" required maxlength="18" 
                     value="{{ cliente.cpf_cnpj if cliente else '' }}">
              <small class="text-muted" id="hint_cpf_cnpj">Digite apenas números</small>
            </div>
            <div class="col-md-9 mb-3">
              <label for="nome" class="form-label" id="label_nome">Nome / Razão Social *</label>
              <input type="text" id="nome" name="nome" class="form-control" 
                     value="{{ cliente.nome if cliente else '' }}" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="apelido" class="form-label">Apelido / Nome Fantasia</label>
              <input type="text" id="apelido" name="apelido" class="form-control" 
                     value="{{ cliente.apelido if cliente else '' }}">
            </div>
            <div class="col-md-3 mb-3">
              <label for="telefone" class="form-label">Telefone *</label>
              <input type="text" id="telefone" name="telefone" class="form-control" 
                     value="{{ cliente.telefone if cliente else '' }}" required>
            </div>
            <div class="col-md-3 mb-3">
              <label for="email" class="form-label">E-mail</label>
              <input type="email" id="email" name="email" class="form-control" 
                     value="{{ cliente.email if cliente else '' }}">
            </div>
          </div>
        </div>
      </div>

      <!-- Endereço -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-map-marker-alt me-2"></i>Endereço
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="cep" class="form-label">CEP</label>
              <input type="text" id="cep" name="cep" class="form-control" maxlength="9" 
                     value="{{ cliente.cep if cliente else '' }}">
              <small class="text-muted">Formato: 00000-000</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="logradouro" class="form-label">Logradouro</label>
              <input type="text" id="logradouro" name="logradouro" class="form-control" 
                     value="{{ cliente.logradouro if cliente else '' }}">
            </div>
            <div class="col-md-3 mb-3">
              <label for="numero" class="form-label">Número</label>
              <input type="text" id="numero" name="numero" class="form-control" 
                     value="{{ cliente.numero if cliente else '' }}">
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="complemento" class="form-label">Complemento</label>
              <input type="text" id="complemento" name="complemento" class="form-control" 
                     value="{{ cliente.complemento if cliente else '' }}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="bairro" class="form-label">Bairro</label>
              <input type="text" id="bairro" name="bairro" class="form-control" 
                     value="{{ cliente.bairro if cliente else '' }}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="cidade" class="form-label">Cidade</label>
              <input type="text" id="cidade" name="cidade" class="form-control" 
                     value="{{ cliente.cidade if cliente else '' }}">
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="uf" class="form-label">UF</label>
              <select id="uf" name="uf" class="form-select">
                <option value="">Selecione o Estado</option>
                <option value="AC" {{ 'selected' if cliente and cliente.uf == 'AC' else '' }}>Acre</option>
                <option value="AL" {{ 'selected' if cliente and cliente.uf == 'AL' else '' }}>Alagoas</option>
                <option value="AP" {{ 'selected' if cliente and cliente.uf == 'AP' else '' }}>Amapá</option>
                <option value="AM" {{ 'selected' if cliente and cliente.uf == 'AM' else '' }}>Amazonas</option>
                <option value="BA" {{ 'selected' if cliente and cliente.uf == 'BA' else '' }}>Bahia</option>
                <option value="CE" {{ 'selected' if cliente and cliente.uf == 'CE' else '' }}>Ceará</option>
                <option value="DF" {{ 'selected' if cliente and cliente.uf == 'DF' else '' }}>Distrito Federal</option>
                <option value="ES" {{ 'selected' if cliente and cliente.uf == 'ES' else '' }}>Espírito Santo</option>
                <option value="GO" {{ 'selected' if cliente and cliente.uf == 'GO' else '' }}>Goiás</option>
                <option value="MA" {{ 'selected' if cliente and cliente.uf == 'MA' else '' }}>Maranhão</option>
                <option value="MT" {{ 'selected' if cliente and cliente.uf == 'MT' else '' }}>Mato Grosso</option>
                <option value="MS" {{ 'selected' if cliente and cliente.uf == 'MS' else '' }}>Mato Grosso do Sul</option>
                <option value="MG" {{ 'selected' if cliente and cliente.uf == 'MG' else '' }}>Minas Gerais</option>
                <option value="PA" {{ 'selected' if cliente and cliente.uf == 'PA' else '' }}>Pará</option>
                <option value="PB" {{ 'selected' if cliente and cliente.uf == 'PB' else '' }}>Paraíba</option>
                <option value="PR" {{ 'selected' if cliente and cliente.uf == 'PR' else '' }}>Paraná</option>
                <option value="PE" {{ 'selected' if cliente and cliente.uf == 'PE' else '' }}>Pernambuco</option>
                <option value="PI" {{ 'selected' if cliente and cliente.uf == 'PI' else '' }}>Piauí</option>
                <option value="RJ" {{ 'selected' if cliente and cliente.uf == 'RJ' else '' }}>Rio de Janeiro</option>
                <option value="RN" {{ 'selected' if cliente and cliente.uf == 'RN' else '' }}>Rio Grande do Norte</option>
                <option value="RS" {{ 'selected' if cliente and cliente.uf == 'RS' else '' }}>Rio Grande do Sul</option>
                <option value="RO" {{ 'selected' if cliente and cliente.uf == 'RO' else '' }}>Rondônia</option>
                <option value="RR" {{ 'selected' if cliente and cliente.uf == 'RR' else '' }}>Roraima</option>
                <option value="SC" {{ 'selected' if cliente and cliente.uf == 'SC' else '' }}>Santa Catarina</option>
                <option value="SP" {{ 'selected' if cliente and cliente.uf == 'SP' else '' }}>São Paulo</option>
                <option value="SE" {{ 'selected' if cliente and cliente.uf == 'SE' else '' }}>Sergipe</option>
                <option value="TO" {{ 'selected' if cliente and cliente.uf == 'TO' else '' }}>Tocantins</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="pais" class="form-label">País</label>
              <input type="text" id="pais" name="pais" class="form-control" 
                     value="{{ cliente.pais if cliente else 'Brasil' }}">
            </div>
          </div>
        </div>
      </div>

      <!-- Informações Adicionais -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-clipboard me-2"></i>Informações Adicionais
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3" id="inscricao_estadual_group">
              <label for="inscricao_estadual" class="form-label">Inscrição Estadual</label>
              <input type="text" id="inscricao_estadual" name="inscricao_estadual" class="form-control" 
                     value="{{ cliente.inscricao_estadual if cliente else '' }}">
            </div>
            <div class="col-md-6 mb-3" id="inscricao_municipal_group">
              <label for="inscricao_municipal" class="form-label">Inscrição Municipal</label>
              <input type="text" id="inscricao_municipal" name="inscricao_municipal" class="form-control" 
                     value="{{ cliente.inscricao_municipal if cliente else '' }}">
            </div>
          </div>
          
          <div class="row">
            <div class="col-12 mb-3">
              <label for="observacoes" class="form-label">Observações</label>
              <textarea id="observacoes" name="observacoes" class="form-control" rows="3">{{ cliente.observacoes if cliente else '' }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="d-flex justify-content-between">
        <a href="{{ url_for('cliente.listar_clientes') }}" class="btn btn-outline-light">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
        <button type="submit" class="btn btn-brand">
          <i class="fas fa-save me-1"></i>
          {{ 'Atualizar Cliente' if cliente else 'Salvar Cliente' }}
        </button>
      </div>
      
    </form>
  </div>
</div>

<script>
$(document).ready(function () {
    // Função para alternar entre CPF e CNPJ
    function alternarTipoPessoa(limparCampo = true) {
        const tipoPessoa = $('input[name="tipo_pessoa"]:checked').val();
        
        if (tipoPessoa === 'PF') {
            $('#cpf_cnpj').mask('000.000.000-00');
            $('#label_cpf_cnpj').text('CPF *');
            $('#label_nome').text('Nome Completo *');
            $('#hint_cpf_cnpj').text('Digite apenas números do CPF');
            $('#inscricao_estadual_group, #inscricao_municipal_group').hide();
        } else {
            $('#cpf_cnpj').mask('00.000.000/0000-00');
            $('#label_cpf_cnpj').text('CNPJ *');
            $('#label_nome').text('Razão Social *');
            $('#hint_cpf_cnpj').text('Digite apenas números do CNPJ');
            $('#inscricao_estadual_group, #inscricao_municipal_group').show();
        }
        
        // Só limpar o campo se for uma mudança manual do usuário
        if (limparCampo) {
            $('#cpf_cnpj').val('').focus();
        }
    }

    // Aplicar máscaras iniciais
    $('#cep').mask('00000-000');
    $('#telefone').mask('(00) 00000-0000');
    
    // Inicializar tipo de pessoa sem limpar o campo (para preservar dados na edição)
    alternarTipoPessoa(false);

    // Evento para mudança de tipo de pessoa (aqui sim limpa o campo)
    $('input[name="tipo_pessoa"]').change(function() {
        alternarTipoPessoa(true);
    });

    // Buscar dados de CNPJ usando BrasilAPI
    $('#cpf_cnpj').blur(function() {
        const documento = $(this).val().replace(/\D/g, '');
        const tipoPessoa = $('input[name="tipo_pessoa"]:checked').val();
        
        if (tipoPessoa === 'PJ' && documento.length === 14) {
            $.ajax({
                url: `https://brasilapi.com.br/api/cnpj/v1/${documento}`,
                method: 'GET',
                success: function(data) {
                    if (!data.message) {
                        $('#nome').val(data.razao_social || '');
                        $('#apelido').val(data.nome_fantasia || '');
                        if (data.cep) {
                            $('#cep').val(data.cep.replace(/\D/g, '').replace(/(\d{5})(\d{3})/, '$1-$2'));
                            buscarCEP(data.cep.replace(/\D/g, ''));
                        }
                        $('#telefone').val(data.ddd_telefone_1 || '');
                        $('#email').val(data.email || '');
                    }
                },
                error: function() {
                    console.log('CNPJ não encontrado ou inválido');
                }
            });
        }
    });

    // Função para buscar endereço pelo CEP
    function buscarCEP(cep) {
        if (cep.length === 8) {
            $.ajax({
                url: `https://viacep.com.br/ws/${cep}/json/`,
                method: 'GET',
                success: function(data) {
                    if (!data.erro) {
                        $('#logradouro').val(data.logradouro || '');
                        $('#bairro').val(data.bairro || '');
                        $('#cidade').val(data.localidade || '');
                        $('#uf').val(data.uf || '');
                        
                        // Focar no campo número
                        $('#numero').focus();
                    }
                },
                error: function() {
                    console.log('CEP não encontrado');
                }
            });
        }
    }

    // Buscar endereço pelo CEP
    $('#cep').blur(function() {
        const cep = $(this).val().replace(/\D/g, '');
        buscarCEP(cep);
    });

    // Validação de formulário
    $('form').on('submit', function(e) {
        const nome = $('#nome').val().trim();
        const cpfCnpj = $('#cpf_cnpj').val().trim();
        const telefone = $('#telefone').val().trim();

        if (!nome) {
            alert('Nome é obrigatório!');
            $('#nome').focus();
            e.preventDefault();
            return false;
        }

        if (!cpfCnpj) {
            alert('CPF/CNPJ é obrigatório!');
            $('#cpf_cnpj').focus();
            e.preventDefault();
            return false;
        }

        if (!telefone) {
            alert('Telefone é obrigatório!');
            $('#telefone').focus();
            e.preventDefault();
            return false;
        }
    });
});
</script>

{% endblock %}