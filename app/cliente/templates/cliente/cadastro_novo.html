<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Editar Cliente' if cliente else 'Cadastro de Cliente' }} - JSP ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        form .form-control, form .form-select {
            border: 2px solid #0d6efd;
            border-radius: 6px;
            box-shadow: none;
            transition: all 0.3s ease-in-out;
        }
        
        form .form-control:focus, form .form-select:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
        
        .card {
            border: 2px solid #ced4da;
            border-radius: 8px;
        }
        
        label {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand"><i class="fas fa-bolt text-warning"></i> JSP ERP</span>
            <a href="/" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
            <a href="{{ url_for('cliente.listar_clientes') }}" class="btn btn-outline-light btn-sm">Lista de Clientes</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card shadow p-4">
            <h4 class="mb-4 text-primary">
                <i class="fas fa-user"></i> 
                {{ 'Editar Cliente' if cliente else 'Cadastro de Cliente' }}
            </h4>
            <form method="POST">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cnpj">CPF / CNPJ *</label>
                        <input type="text" id="cnpj" name="cpf_cnpj" class="form-control" required maxlength="18" value="{{ cliente.cpf_cnpj if cliente else '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cep">CEP</label>
                        <input type="text" id="cep" name="cep" class="form-control" maxlength="9" value="{{ cliente.cep if cliente else '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome">Nome / Razão Social *</label>
                        <input type="text" id="nome" name="nome" class="form-control" value="{{ cliente.nome if cliente else '' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nome_fantasia">Nome Fantasia</label>
                        <input type="text" id="nome_fantasia" name="nome_fantasia" class="form-control" value="{{ cliente.nome_fantasia if cliente else '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="endereco">Endereço</label>
                        <input type="text" id="endereco" name="endereco" class="form-control" value="{{ cliente.endereco if cliente else '' }}">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="numero">Número</label>
                        <input type="text" id="numero" name="numero" class="form-control" value="{{ cliente.numero if cliente else '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="bairro">Bairro</label>
                        <input type="text" id="bairro" name="bairro" class="form-control" value="{{ cliente.bairro if cliente else '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cidade">Cidade</label>
                        <input type="text" id="cidade" name="cidade" class="form-control" value="{{ cliente.cidade if cliente else '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="estado">Estado</label>
                        <input type="text" id="estado" name="estado" class="form-control" value="{{ cliente.estado if cliente else '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="complemento">Complemento</label>
                        <input type="text" name="complemento" id="complemento" class="form-control" value="{{ cliente.complemento if cliente else '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="email">E-mail</label>
                        <input type="email" name="email" id="email" class="form-control" value="{{ cliente.email if cliente else '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="telefone">Telefone</label>
                        <input type="text" name="telefone" id="telefone" class="form-control" value="{{ cliente.telefone if cliente else '' }}">
                    </div>
                </div>

                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        {{ 'Atualizar Cliente' if cliente else 'Salvar Cliente' }}
                    </button>
                    <a href="{{ url_for('cliente.listar_clientes') }}" class="btn btn-secondary ms-2">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- jQuery Mask Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function () {
            // Máscara dinâmica para CPF/CNPJ
            $('#cnpj').on('input', function() {
                var value = $(this).val().replace(/\D/g, '');
                if (value.length <= 11) {
                    // CPF: 000.000.000-00
                    $(this).mask('000.000.000-00', {reverse: true});
                } else {
                    // CNPJ: 00.000.000/0000-00
                    $(this).mask('00.000.000/0000-00', {reverse: true});
                }
            });

            // Máscara para CEP
            $('#cep').mask('00000-000');

            // Máscara para telefone
            $('#telefone').mask('(00) 00000-0000');

            // Auto-trigger da máscara baseado no valor inicial
            $('#cnpj').trigger('input');
        });

        // Busca automática de CNPJ
        document.getElementById('cnpj').addEventListener('blur', function () {
            const cnpj = this.value.replace(/\D/g, '');
            if (cnpj.length === 14) {
                fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.message) {
                            document.getElementById('nome').value = data.razao_social || '';
                            document.getElementById('nome_fantasia').value = data.nome_fantasia || '';
                            document.getElementById('cep').value = data.cep || '';
                            document.getElementById('endereco').value = `${data.descricao_tipo_de_logradouro || ''} ${data.logradouro || ''}`.trim();
                            document.getElementById('bairro').value = data.bairro || '';
                            document.getElementById('cidade').value = data.municipio || '';
                            document.getElementById('estado').value = data.uf || '';
                        } else {
                            alert('CNPJ não encontrado');
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao buscar CNPJ:', err);
                        alert('Erro ao consultar CNPJ. Tente novamente.');
                    });
            }
        });

        // Busca automática de CEP
        document.getElementById('cep').addEventListener('blur', function () {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('endereco').value = data.logradouro || '';
                            document.getElementById('bairro').value = data.bairro || '';
                            document.getElementById('cidade').value = data.localidade || '';
                            document.getElementById('estado').value = data.uf || '';
                        } else {
                            alert('CEP não encontrado');
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao buscar CEP:', err);
                        alert('Erro ao consultar CEP. Tente novamente.');
                    });
            }
        });
    </script>
</body>
</html>
