{% extends 'base.html' %}
{% block titulo %}Condições de Pagamento - JSP ERP{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- PAGE TITLE / TOOLBAR (azul, alinhado ao seu padrão) -->
    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
        <div class="d-flex align-items-center gap-2">
            <span class="icon-tile"><i class="fas fa-credit-card"></i></span>
            <h2 class="m-0 fw-semibold text-brand">Condições de Pagamento</h2>
        </div>
        <div class="ms-auto d-flex gap-2">
            <div class="input-group search-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input id="searchInput" type="text" class="form-control" placeholder="Buscar por descrição, tipo ou parcelas...">
                <button class="btn btn-glow" type="button" onclick="document.getElementById('searchInput').focus()">Buscar</button>
            </div>
            <a href="{{ url_for('configuracoes_condicoes_pagamento.nova_condicao_pagamento') }}" class="btn btn-gradient fw-semibold">
                <i class="fas fa-plus"></i> Novo
            </a>
        </div>
    </div>

    <!-- CARD / BASE DE CONDIÇÕES -->
    <div class="card-glass mb-3">
        <div class="card-glass-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <span class="pill-icon"><i class="fas fa-database"></i></span>
                <span class="h5 m-0">Base de Condições</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="kpi-dot"></span>
                <small class="text-muted">{{ condicoes|length }} registro(s)</small>
                <button id="btnExportCsv" type="button" class="btn btn-outline-gradient btn-sm">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="tabela-condicoes" class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th class="text-nowrap">Código</th>
                        <th>Descrição</th>
                        <th>Tipo</th>
                        <th class="text-center">Parcelas</th>
                        <th class="text-center">Desconto (%)</th>
                        <th class="text-center">Juros (%)</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if condicoes|length == 0 %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">Nenhuma condição de pagamento cadastrada.</td>
                    </tr>
                    {% else %}
                    {% for condicao in condicoes %}
                    <tr>
                        <td class="text-nowrap">CPG{{ '%04d'|format(condicao.id) }}</td>
                        <td><a class="link-brand" href="{{ url_for('configuracoes_condicoes_pagamento.editar_condicao_pagamento', id=condicao.id) }}">{{ condicao.descricao }}</a></td>
                        <td>
                            {% if (condicao.tipo or '').lower() in ['à vista','a vista','avista'] %}
                                <span class="badge badge-soft-success">À vista</span>
                            {% else %}
                                <span class="badge badge-soft-info">{{ condicao.tipo }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ condicao.parcelas }}</td>
                        <td class="text-center">{{ '%.2f'|format(condicao.desconto or 0) }}</td>
                        <td class="text-center">{{ '%.2f'|format(condicao.juros or 0) }}</td>
                        <td class="text-center">
                            <div class="btn-icon-group" role="group">
                                <!-- padronizado com ícones quadrados/azuis -->
                                <a href="{{ url_for('configuracoes_condicoes_pagamento.editar_condicao_pagamento', id=condicao.id) }}" class="btn-icon" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <form action="{{ url_for('configuracoes_condicoes_pagamento.excluir_condicao_pagamento', id=condicao.id) }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir esta condição?');">
                                    <button type="submit" class="btn-icon btn-icon-danger" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    :root{
        --brand-1:#00c6ff; /* ciano vivo */
        --brand-2:#005bea; /* azul profundo */
        --ink:#dbe7ff;     /* texto claro */
        --panel:#0b1f38;   /* fundo painel */
        --panel-2:#0f2747; /* linhas */
        --border:#21a0ff33;
        --success-soft:#1dd1a1;
    }
    .text-brand{color:#cfe8ff}
    .icon-tile{
        display:inline-flex;align-items:center;justify-content:center;
        width:42px;height:42px;border-radius:12px;
        background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
        color:white;box-shadow:0 6px 18px #0090ff55
    }
    .btn-gradient{
        background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
        border:none;color:#fff;border-radius:10px;padding:.55rem .95rem
    }
    .btn-gradient:hover{filter:brightness(1.05)}
    .btn-outline-gradient{
        border:1px solid var(--border); color:#cfe8ff; background:transparent;
        border-radius:10px; padding:.35rem .75rem
    }
    .btn-outline-gradient:hover{background:linear-gradient(135deg,#0a2a4a88,#0a2a4a55)}
    .btn-glow{background:#0ea5ff;border:0;color:#03213c;border-radius:0 .6rem .6rem 0}

    .search-group .input-group-text{border:0;background:#0d2d52;color:#9fcbff}
    .search-group .form-control{border:0;background:#0a2342;color:#cfe8ff}

    .card-glass{background:rgba(11,31,56,.6); border:1px solid var(--border);
        border-radius:16px; box-shadow:0 10px 30px #00142a55; overflow:hidden}
    .card-glass-header{padding:12px 16px; background:linear-gradient(180deg,rgba(0,198,255,.1),rgba(0,91,234,.05)); border-bottom:1px solid var(--border)}

    .pill-icon{display:inline-flex;width:30px;height:30px;border-radius:8px;align-items:center;justify-content:center;background:linear-gradient(135deg,#2bd9ff22,#2b6bff22); color:#8fd3ff}
    .kpi-dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(135deg,#22ffc6,#0aefff); display:inline-block}

    table.table-dark{--bs-table-bg:#0f2747; --bs-table-striped-bg:#0d2341; --bs-table-hover-bg:#11305a; color:#cfe8ff}
    table.table-dark thead th{background:linear-gradient(180deg,#0b2546,#0a1f3a); border-bottom:1px solid var(--border); color:#cfe8ff}
    #tabela-condicoes td, #tabela-condicoes th{vertical-align:middle; border-color:#0c2a4a}
    #tabela-condicoes tbody tr:hover{outline:1px dashed #21a0ff55}

    .badge-soft-success{background:#1dd1a122;color:#7ff0d4;border:1px solid #1dd1a133;border-radius:.5rem;padding:.25rem .5rem}
    .badge-soft-info{background:#2bb3ff22;color:#8fd3ff;border:1px solid #2bb3ff33;border-radius:.5rem;padding:.25rem .5rem}

    .btn-icon-group{display:inline-flex;gap:.35rem}
    .btn-icon{width:36px;height:36px;border:0;border-radius:.6rem;display:inline-flex;align-items:center;justify-content:center; background:linear-gradient(135deg,#0f2e57,#0b2346); color:#cfe8ff}
    .btn-icon:hover{filter:brightness(1.15)}
    .btn-icon-danger{background:linear-gradient(135deg,#2e0f1c,#460b0b); color:#ffd4d4}

    .link-brand{color:#7fd3ff; text-decoration:none}
    .link-brand:hover{text-decoration:underline}
</style>

<script>
    // Filtro client-side
    (function(){
        const input = document.getElementById('searchInput');
        const table = document.getElementById('tabela-condicoes');
        if(!input || !table) return;
        input.addEventListener('input', function(){
            const term = this.value.toLowerCase();
            table.querySelectorAll('tbody tr').forEach(tr => {
                if(tr.children.length === 1) { tr.style.display = ''; return; }
                tr.style.display = tr.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        });
    })();

    // Exportar CSV, ignorando coluna Ações
    (function(){
        const btn = document.getElementById('btnExportCsv');
        const table = document.getElementById('tabela-condicoes');
        if(!btn || !table) return;
        btn.addEventListener('click', function(){
            const rows = Array.from(table.querySelectorAll('tr')).filter(tr => tr.querySelectorAll('th,td').length > 1);
            const data = rows.map((tr, idx) => {
                const cells = Array.from(tr.querySelectorAll(idx===0? 'th':'td'));
                const slice = cells.slice(0, Math.max(0, cells.length - 1));
                return slice.map(td => '"' + (td.innerText || '').replaceAll('"','""') + '"').join(',');
            }).join('
');
            const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `condicoes_pagamento_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        });
    })();
</script>
{% endblock %}
