<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Ordens de Serviço - JSP ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .secao-formulario {
            border: 2px solid #28a745;
            border-radius: 10px;
            background: linear-gradient(135deg, #e8f5e8, #f0f9f0);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .table th {
            background-color: #28a745;
            color: white;
            border: none;
        }
        
        .badge-status {
            padding: 0.4em 0.8em;
            border-radius: 0.35rem;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .badge-aberta { background-color: #17a2b8; }
        .badge-andamento { background-color: #ffc107; color: #212529; }
        .badge-concluida { background-color: #28a745; }
        .badge-cancelada { background-color: #dc3545; }
        
        body {
            background-color: #f8f9fa;
        }
        
        .navbar {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border: none;
            color: white;
        }
        
        .btn-export:hover {
            background: linear-gradient(135deg, #138496, #0c6674);
            color: white;
        }
        
        @media print {
            .no-print { display: none !important; }
            .table { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark no-print">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-bolt text-warning"></i> JSP ERP
            </a>
            <div class="d-flex">
                <a href="{{ url_for('relatorio.index_relatorios') }}" class="btn btn-outline-light me-2">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <a href="/" class="btn btn-outline-light">Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Cabeçalho -->
        <div class="secao-formulario">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="mb-0">
                        <i class="fas fa-tools text-success"></i> Relatório de Ordens de Serviço
                    </h2>
                    <p class="text-muted mb-0">Análise detalhada das ordens de serviço com filtros</p>
                </div>
                <div class="col-auto no-print">
                    <button onclick="window.print()" class="btn btn-outline-success me-2">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <a href="{{ url_for('relatorio.export_os_csv', **filtros) }}" class="btn btn-export">
                        <i class="fas fa-download"></i> Exportar CSV
                    </a>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="secao-formulario no-print">
            <h5><i class="fas fa-filter text-success"></i> Filtros</h5>
            <form method="GET" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Data Início</label>
                    <input type="date" class="form-control" name="data_inicio" 
                           value="{{ filtros.data_inicio or '' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data Fim</label>
                    <input type="date" class="form-control" name="data_fim" 
                           value="{{ filtros.data_fim or '' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">Todos</option>
                        <option value="Aberta" {{ 'selected' if filtros.status == 'Aberta' }}>Aberta</option>
                        <option value="Em Andamento" {{ 'selected' if filtros.status == 'Em Andamento' }}>Em Andamento</option>
                        <option value="Concluída" {{ 'selected' if filtros.status == 'Concluída' }}>Concluída</option>
                        <option value="Cancelada" {{ 'selected' if filtros.status == 'Cancelada' }}>Cancelada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cliente</label>
                    <select class="form-select" name="cliente_id">
                        <option value="">Todos os Clientes</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {{ 'selected' if filtros.cliente_id == cliente.id|string }}>
                            {{ cliente.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Técnico</label>
                    <input type="text" class="form-control" name="tecnico" 
                           value="{{ filtros.tecnico or '' }}" placeholder="Nome do técnico">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-list-ol fa-2x mb-2"></i>
                    <h4>{{ total_os }}</h4>
                    <p class="mb-0">Total de OS</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h4>R$ {{ "%.2f"|format(valor_total) }}</h4>
                    <p class="mb-0">Valor Total</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4>R$ {{ "%.2f"|format(valor_medio) }}</h4>
                    <p class="mb-0">Valor Médio</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h4>{{ stats_status|length }}</h4>
                    <p class="mb-0">Status Diferentes</p>
                </div>
            </div>
        </div>

        <!-- Estatísticas por Status -->
        {% if stats_status %}
        <div class="secao-formulario">
            <h5><i class="fas fa-chart-pie text-success"></i> Distribuição por Status</h5>
            <div class="row">
                {% for status, stats in stats_status.items() %}
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title">{{ status }}</h6>
                            <h4 class="text-primary">{{ stats.count }}</h4>
                            <p class="text-muted">R$ {{ "%.2f"|format(stats.valor) }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Lista de Ordens de Serviço -->
        {% if ordens %}
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Cliente</th>
                                <th>Data Emissão</th>
                                <th>Status</th>
                                <th>Técnico</th>
                                <th>Valor Serviços</th>
                                <th>Valor Produtos</th>
                                <th>Valor Total</th>
                                <th class="no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for os in ordens %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ os.codigo }}</strong>
                                </td>
                                <td>
                                    <strong>{{ os.cliente.nome if os.cliente else 'Cliente ID: ' + os.cliente_id|string }}</strong>
                                </td>
                                <td>
                                    {{ os.data_emissao.strftime('%d/%m/%Y') if os.data_emissao else '-' }}
                                </td>
                                <td>
                                    <span class="badge badge-status badge-{{ os.status.lower().replace(' ', '').replace('ã', 'a').replace('í', 'i') if os.status else 'aberta' }}">
                                        {{ os.status or 'Aberta' }}
                                    </span>
                                </td>
                                <td>
                                    {{ os.tecnico_responsavel or '-' }}
                                </td>
                                <td>
                                    <span class="text-success fw-bold">
                                        R$ {{ "%.2f"|format(os.valor_servicos) if os.valor_servicos else "0,00" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-info fw-bold">
                                        R$ {{ "%.2f"|format(os.valor_produtos) if os.valor_produtos else "0,00" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-primary fw-bold">
                                        R$ {{ "%.2f"|format(os.valor_total) if os.valor_total else "0,00" }}
                                    </span>
                                </td>
                                <td class="no-print">
                                    <a href="{{ url_for('os.editar_os', id=os.id) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="5">TOTAIS</th>
                                <th class="text-success">
                                    R$ {{ "%.2f"|format(ordens|sum(attribute='valor_servicos') or 0) }}
                                </th>
                                <th class="text-info">
                                    R$ {{ "%.2f"|format(ordens|sum(attribute='valor_produtos') or 0) }}
                                </th>
                                <th class="text-primary">
                                    R$ {{ "%.2f"|format(valor_total) }}
                                </th>
                                <th class="no-print"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Estado vazio -->
        <div class="text-center py-5">
            <i class="fas fa-search fa-5x text-muted mb-3"></i>
            <h4 class="text-muted">Nenhuma ordem de serviço encontrada</h4>
            <p class="text-muted mb-4">Ajuste os filtros para encontrar as OS desejadas</p>
        </div>
        {% endif %}

        <!-- Rodapé do Relatório -->
        <div class="row mt-4 mb-4">
            <div class="col-12 text-center text-muted">
                <small>
                    Relatório gerado em {{ moment().format('DD/MM/YYYY HH:mm') }} - JSP ERP
                    {% if total_os > 0 %}
                    | {{ total_os }} registro(s) encontrado(s)
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para formatar datas
        function formatDate() {
            const now = new Date();
            return now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
        }
        
        // Substituir o momento da geração
        document.addEventListener('DOMContentLoaded', function() {
            const dateElement = document.querySelector('small');
            if (dateElement) {
                dateElement.innerHTML = dateElement.innerHTML.replace('{{ moment().format(\'DD/MM/YYYY HH:mm\') }}', formatDate());
            }
        });
    </script>
</body>
</html>
