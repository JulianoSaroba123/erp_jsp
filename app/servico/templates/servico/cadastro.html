{% extends "base.html" %}
{% block titulo %}{{ 'Editar Serviço' if servico else 'Novo Serviço' }} — JSP ERP{% endblock %}

{% block content %}
<div class="page-title">
  <div class="ico"><i class="fas fa-concierge-bell"></i></div>
  <h3 style="margin:0;">{{ 'Editar Serviço' if servico else 'Cadastro de Serviço' }}</h3>
</div>

<div class="card card-jsp mb-3">
  <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-tools"></i>
      <strong>{{ 'Edição de Serviço' if servico else 'Novo Serviço' }}</strong>
      {% if servico and servico.codigo %}
        <code>{{ servico.codigo }}</code>
      {% endif %}
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-light btn-sm" style="border-color:rgba(255,255,255,.25)"
         href="{{ url_for('servico.listar_servicos') }}">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <div class="card-body">
    <form method="POST">
      <!-- Informações Básicas -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-info-circle me-2"></i>Informações Básicas
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <label for="nome" class="form-label">Nome do Serviço *</label>
              <input type="text" id="nome" name="nome" class="form-control"
                     value="{{ servico.nome if servico else '' }}" required>
            </div>
            <div class="col-6 col-lg-2">
              <label for="unidade" class="form-label">Unidade</label>
              <select id="unidade" name="unidade" class="form-select">
                <option value="UN" {{ 'selected' if servico and servico.unidade=='UN' else '' }}>UN</option>
                <option value="H"  {{ 'selected' if servico and servico.unidade=='H'  else '' }}>H</option>
                <option value="M2" {{ 'selected' if servico and servico.unidade=='M2' else '' }}>M2</option>
                <option value="KM" {{ 'selected' if servico and servico.unidade=='KM' else '' }}>KM</option>
                <option value="DIA"{{ 'selected' if servico and servico.unidade=='DIA' else '' }}>DIA</option>
              </select>
            </div>
            <div class="col-6 col-lg-2 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="ativo" name="ativo"
                       {% if not servico or servico.ativo %}checked{% endif %}>
                <label class="form-check-label" for="ativo">Ativo</label>
              </div>
            </div>

            <div class="col-12">
              <label for="descricao" class="form-label">Descrição</label>
              <textarea id="descricao" name="descricao" class="form-control" rows="3">{{ servico.descricao if servico else '' }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Calculadora de Preços -->
      <div class="card card-jsp mb-4">
        <div class="card-header">
          <i class="fas fa-calculator me-2"></i>Calculadora de Preços
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label for="preco_custo" class="form-label">Preço de Custo (R$) *</label>
              <input type="number" id="preco_custo" name="preco_custo" class="form-control" step="0.01"
                     value="{{ '%.2f'|format(servico.preco_custo) if servico and servico.preco_custo is not none else '0' }}"
                     required>
            </div>
            <div class="col-12 col-md-4">
              <label for="markup_percentual" class="form-label">Markup (%)</label>
              {# campo “transitório” para cálculo; não precisa existir no model #}
              {% set mk_auto = (
                   ((servico.preco_venda|default(0)) - (servico.preco_custo|default(0))) /
                   (servico.preco_custo if servico and servico.preco_custo and servico.preco_custo>0 else 1) * 100
                 ) if servico else 0 %}
              <input type="number" id="markup_percentual" name="markup_percentual" class="form-control" step="0.01"
                     value="{{ '%.2f'|format(mk_auto) if servico else '0' }}">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Preço de Venda (R$)</label>
              <input type="text" id="preco_venda_display" class="form-control" readonly placeholder="R$ 0,00">
              <input type="hidden" id="preco_venda" name="preco_venda"
                     value="{{ '%.2f'|format(servico.preco_venda) if servico and servico.preco_venda is not none else '0' }}">
            </div>

            <div class="col-12 col-md-6">
              <div class="card card-jsp">
                <div class="card-body text-center">
                  <div class="small text-muted">Markup em R$</div>
                  <div class="fs-5 fw-bold" id="markup_valor">R$ 0,00</div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="card card-jsp">
                <div class="card-body text-center">
                  <div class="small text-muted">Margem de Lucro</div>
                  <div class="fs-5 fw-bold" id="margem_lucro">0,0%</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ações -->
      <div class="text-end">
        <button type="submit" class="btn btn-brand">
          <i class="fas fa-save me-1"></i>{{ 'Atualizar Serviço' if servico else 'Salvar Serviço' }}
        </button>
        <a href="{{ url_for('servico.listar_servicos') }}" class="btn btn-outline-light ms-2" style="border-color:rgba(255,255,255,.25)">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  /* inputs dark/glass iguais às outras telas */
  .card-jsp .form-control, .card-jsp .form-select{
    color:#eaf6ff; background: rgba(15,31,54,.55);
    border:1px solid rgba(255,255,255,.12);
  }
  .card-jsp .form-control::placeholder{ color:#9fb3d6; opacity:.9 }
</style>

<script>
  (function () {
    function toBR(value){
      return value.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function calcular(){
      const pc = parseFloat(document.getElementById('preco_custo').value) || 0;
      const mk = parseFloat(document.getElementById('markup_percentual').value) || 0;

      if(pc > 0){
        const mkR$ = pc * (mk/100);
        const pv   = pc + mkR$;
        const margem = pv > 0 ? ((pv - pc) / pv) * 100 : 0;

        document.getElementById('preco_venda_display').value = 'R$ ' + toBR(pv);
        document.getElementById('preco_venda').value = pv.toFixed(2);
        document.getElementById('markup_valor').textContent = 'R$ ' + toBR(mkR$);
        document.getElementById('margem_lucro').textContent = margem.toFixed(1) + '%';
      } else {
        document.getElementById('preco_venda_display').value = 'R$ 0,00';
        document.getElementById('preco_venda').value = '0';
        document.getElementById('markup_valor').textContent = 'R$ 0,00';
        document.getElementById('margem_lucro').textContent = '0,0%';
      }
    }

    // inicia com valores existentes
    calcular();
    document.getElementById('preco_custo').addEventListener('input', calcular);
    document.getElementById('markup_percentual').addEventListener('input', calcular);

    // validação simples no submit
    document.querySelector('form').addEventListener('submit', function(e){
      const nome = (document.getElementById('nome').value || '').trim();
      const pc   = parseFloat(document.getElementById('preco_custo').value) || 0;
      if(!nome){ alert('Nome do serviço é obrigatório!'); e.preventDefault(); }
      else if(pc <= 0){ alert('Preço de custo deve ser maior que zero!'); e.preventDefault(); }
    });
  })();
</script>
{% endblock %}
